<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการ - ปอมปอม บูทีค</title>
    <link rel="stylesheet" href="admin-style.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div>
                <div class="sidebar-logo">Admin<span>.</span></div>
                <nav class="sidebar-nav">
                    <h3>เมนูหลัก</h3>
                    <ul>
                        <li><a href="admin.html" class="active">จัดการน้องหมา</a></li>
                        <li><a href="settings.html">ตั้งค่าเว็บไซต์</a></li>
                    </ul>
                </nav>
            </div>
             <nav class="sidebar-nav">
                <ul>
                    <li><a href="index.html" target="_blank">ดูหน้าร้าน</a></li>
                    <li><a href="#" class="logout-link" id="logout-button">ออกจากระบบ</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="mobile-header">
                <div class="mobile-logo">Admin<span>.</span></div>
                <button class="mobile-menu-button" id="menu-toggle">☰</button>
            </header>
            
            <header class="desktop-header">
                <h1>จัดการน้องหมา</h1>
                <a href="add-item.html" class="button button-primary">เพิ่มน้องหมาตัวใหม่</a>
            </header>

            <div class="admin-card">
                 <h2>รายการทั้งหมด (ลากเพื่อจัดลำดับ)</h2>
                 <table class="product-table">
                     <thead>
                         <tr><th class="drag-header"></th><th>ข้อมูลน้องหมา</th><th>สถานะ</th><th>ราคา</th><th>การกระทำ</th></tr>
                     </thead>
                     <tbody id="product-table-body">
                         <!-- Dynamic rows will be inserted here -->
                     </tbody>
                 </table>
            </div>
        </main>
    </div>

    <!-- SDKs -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // Define Firebase Config
        const firebaseConfig = {
          apiKey: "AIzaSyA85L7n2CGKocgWg-Z8TsNlUN9AVVJguBQ",
          authDomain: "cesarkennel.firebaseapp.com",
          projectId: "cesarkennel",
          storageBucket: "cesarkennel.firebasestorage.app",
          messagingSenderId: "512752480416",
          appId: "1:512752480416:web:c71aa9dc281a3932b419c5"
        };
        const app = firebase.initializeApp(firebaseConfig);
        
        // --- AUTH GUARD ---
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                // User is signed in, load page content.
                fetchAndDisplayDogs();
            } else {
                // No user is signed in, redirect.
                window.location.href = 'login.html';
            }
        });
    </script>
    
    <script src="script.js"></script>

    <script>
        // Page-specific JavaScript
        const db = firebase.firestore();
        const tableBody = document.getElementById('product-table-body');

        function createTableRow(dogData, docId) {
            const row = document.createElement('tr');
            row.setAttribute('data-id', docId);

            let statusText = 'พร้อมขาย';
            if (dogData.status === 'preordered') statusText = 'ติดจอง';
            if (dogData.status === 'sold') statusText = 'ขายแล้ว';
            
            row.innerHTML = `
                <td><span class="drag-handle">☰</span></td>
                <td data-label="ข้อมูล">
                    <div class="product-info-cell">
                        <img src="${dogData.imageUrls && dogData.imageUrls.length > 0 ? dogData.imageUrls[0] : 'https://via.placeholder.com/100'}" alt="${dogData.name}">
                        <div>
                            <div class="name">${dogData.name}</div>
                            <div class="details">${dogData.breed} (${dogData.gender}, ${dogData.color})</div>
                        </div>
                    </div>
                </td>
                <td data-label="สถานะ"><span class="status-badge ${dogData.status}">${statusText}</span></td>
                <td data-label="ราคา">${dogData.price.toLocaleString()} บาท</td>
                <td data-label="การกระทำ">
                    <div class="action-buttons">
                        <a href="add-item.html?id=${docId}" class="button edit-btn">แก้ไข</a>
                        <button class="button delete-btn" data-id="${docId}" data-name="${dogData.name}">ลบ</button>
                    </div>
                </td>
            `;
            return row;
        }

        async function fetchAndDisplayDogs() {
            tableBody.innerHTML = '<tr><td colspan="5">กำลังโหลด...</td></tr>';
            const dogsSnapshot = await db.collection("dogs").orderBy("order", "asc").get();
            tableBody.innerHTML = '';
            
            if (dogsSnapshot.empty) {
                tableBody.innerHTML = '<tr><td colspan="5">ยังไม่มีข้อมูลน้องหมาในระบบ</td></tr>';
                return;
            }
            
            dogsSnapshot.forEach(doc => {
                const row = createTableRow(doc.data(), doc.id);
                tableBody.appendChild(row);
            });
            
            setupActionListeners();
            initializeSortable();
        }

        function setupActionListeners() {
            tableBody.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const docId = e.target.dataset.id;
                    const dogName = e.target.dataset.name;
                    if (confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบ "${dogName}"?`)) {
                        try {
                            await db.collection("dogs").doc(docId).delete();
                            alert('ลบข้อมูลสำเร็จ!');
                            fetchAndDisplayDogs();
                        } catch (error) {
                            console.error("Error deleting document: ", error);
                            alert('เกิดข้อผิดพลาดในการลบ');
                        }
                    }
                });
            });
        }
        
        function initializeSortable() {
            new Sortable(tableBody, {
                handle: '.drag-handle',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: async function (evt) {
                    const rows = tableBody.querySelectorAll('tr');
                    const batch = db.batch();
                    
                    rows.forEach((row, index) => {
                        const docId = row.dataset.id;
                        if (docId) {
                            const docRef = db.collection("dogs").doc(docId);
                            batch.update(docRef, { order: index });
                        }
                    });
                    
                    try {
                        await batch.commit();
                        console.log('Order updated successfully!');
                    } catch (error) {
                        console.error('Error updating order:', error);
                        alert('เกิดข้อผิดพลาดในการบันทึกลำดับ');
                    }
                }
            });
        }
    </script>
</body>
</html>