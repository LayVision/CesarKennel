<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการสุนัข - แผงควบคุม</title>
    <link rel="stylesheet" href="admin-style.css?v=2.0">
</head>
<body>
    <div class="admin-layout">
        <aside class="sidebar" id="sidebar">
            <div>
                <div class="sidebar-logo">Admin<span>.</span></div>
                <nav class="sidebar-nav">
                    <h3>เมนูหลัก</h3>
                    <ul>
                        <li><a href="admin.html" class="active">จัดการสุนัข</a></li>
                        <li><a href="settings.html">ตั้งค่าเว็บไซต์</a></li>
                    </ul>
                </nav>
            </div>
             <nav class="sidebar-nav">
                <ul>
                    <li><a href="index.html">ดูหน้าร้าน</a></li>
                    <li><a href="#" class="logout-link" id="logout-button">ออกจากระบบ</a></li>
                </ul>
            </nav>
        </aside>

        <main class="admin-main">
             <!-- MODIFICATION START: Added a wrapper for buttons and the new "Add" button -->
             <header class="mobile-header">
                <div class="mobile-logo">Admin<span>.</span></div>
                <div class="mobile-header-actions">
                    <a href="add-item.html" class="button button-primary mobile-add-btn">+ เพิ่มสุนัขใหม่</a>
                    <button class="mobile-menu-button" id="menu-toggle">☰</button>
                </div>
            </header>
            <!-- MODIFICATION END -->

            <header class="desktop-header">
                <h1>จัดการสุนัข</h1>
                <a href="add-item.html" class="button button-primary">+ เพิ่มสุนัขใหม่</a>
            </header>

            <div class="admin-card">
                 <h2>รายการสุนัขทั้งหมด (ลากเพื่อจัดลำดับ)</h2>
                 <div class="product-table-wrapper">
                    <table class="product-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;"></th> <!-- Handle for drag-drop -->
                                <th>ข้อมูลสุนัข</th>
                                <th>สถานะ</th>
                                <th>ราคา</th>
                                <th style="width: 150px;">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="product-list">
                            <!-- Product rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="script.js"></script>

    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, orderBy, doc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA85L7n2CGKocgWg-Z8TsNlUN9AVVJguBQ",
            authDomain: "cesarkennel.firebaseapp.com",
            projectId: "cesarkennel",
            storageBucket: "cesarkennel.firebasestorage.app",
            messagingSenderId: "512752480416",
            appId: "1:512752480416:web:c71aa9dc281a3932b419c5"
        };
        
        const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);
        const auth = getAuth(app);

        onAuthStateChanged(auth, user => { if (!user) window.location.href = 'login.html' });
        document.getElementById('logout-button')?.addEventListener('click', (e) => {
            e.preventDefault();
            signOut(auth).then(() => {
                alert('คุณออกจากระบบแล้ว');
                window.location.href = 'index.html';
            });
        });

        const productList = document.getElementById('product-list');
        let productsCache = [];

        const fetchProducts = async () => {
            productList.innerHTML = `<tr><td colspan="5" style="text-align:center;">กำลังโหลดข้อมูล...</td></tr>`;
            const q = query(collection(db, "products"), orderBy("orderPosition", "asc"));
            const querySnapshot = await getDocs(q);
            
            productsCache = []; // Clear cache before fetching
            querySnapshot.forEach(doc => {
                productsCache.push({ id: doc.id, ...doc.data() });
            });
            
            renderProducts();
        };

        const renderProducts = () => {
            productList.innerHTML = ''; // Clear table
            if (productsCache.length === 0) {
                 productList.innerHTML = `<tr><td colspan="5" style="text-align:center;">ยังไม่มีข้อมูลสุนัขในระบบ</td></tr>`;
                 return;
            }

            productsCache.forEach(product => {
                const statusMap = {
                    available: { class: 'available', text: 'พร้อมย้ายบ้าน' },
                    preordered: { class: 'preordered', text: 'ติดจอง' },
                    sold: { class: 'sold', text: 'ขายแล้ว' }
                };
                const statusInfo = statusMap[product.status] || statusMap.available;
                
                const tr = document.createElement('tr');
                tr.dataset.id = product.id;
                tr.innerHTML = `
                    <td style="cursor: grab; text-align: center;" class="drag-handle">☰</td>
                    <td data-label="ข้อมูลสุนัข">
                        <div class="product-info-cell">
                            <img src="${product.thumbnailUrl || 'https://via.placeholder.com/60'}" alt="${product.name}">
                            <div>
                                <a href="product-detail.html?id=${product.id}" target="_blank" class="name">${product.name}</a>
                                <div class="details">เพศ${product.gender}</div>
                            </div>
                        </div>
                    </td>
                    <td data-label="สถานะ"><span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></td>
                    <td data-label="ราคา">${product.price.toLocaleString('th-TH')} บาท</td>
                    <td data-label="จัดการ">
                        <div class="action-buttons">
                            <a href="add-item.html?id=${product.id}" class="button edit-btn">แก้ไข</a>
                            <button class="button delete-btn" data-id="${product.id}">ลบ</button>
                        </div>
                    </td>
                `;
                productList.appendChild(tr);
            });
        };

        productList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const id = e.target.dataset.id;
                const row = e.target.closest('tr');
                const productName = row.querySelector('.name').textContent;

                if (confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบ "${productName}"?`)) {
                    try {
                        await deleteDoc(doc(db, 'products', id));
                        row.remove();
                        alert('ลบข้อมูลสำเร็จ');
                    } catch (error) {
                        console.error("Error removing document: ", error);
                        alert('เกิดข้อผิดพลาดในการลบข้อมูล');
                    }
                }
            }
        });

        new Sortable(productList, {
            handle: '.drag-handle',
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: async (evt) => {
                const items = Array.from(productList.querySelectorAll('tr'));
                const batch = writeBatch(db);
                
                items.forEach((item, index) => {
                    const docId = item.dataset.id;
                    const docRef = doc(db, 'products', docId);
                    batch.update(docRef, { orderPosition: index });
                });

                try {
                    await batch.commit();
                    fetchProducts();
                } catch (error) {
                    console.error("Error updating order: ", error);
                    alert("เกิดข้อผิดพลาดในการจัดลำดับ");
                }
            },
        });


        fetchProducts();
    </script>
</body>
</html>