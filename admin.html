<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการ - ปอมปอม บูทีค</title>
    <link rel="stylesheet" href="admin-style.css">
</head>

<body>
    <div class="admin-layout">
        <aside class="sidebar" id="sidebar">
            <div>
                <div class="sidebar-logo">Admin<span>.</span></div>
                <nav class="sidebar-nav">
                    <h3>เมนูหลัก</h3>
                    <ul>
                        <li><a href="admin.html" class="active">จัดการน้องหมา</a></li>
                        <li><a href="settings.html">ตั้งค่าเว็บไซต์</a></li>
                    </ul>
                </nav>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="index.html">ดูหน้าร้าน</a></li>
                    <li><a href="#" class="logout-link" id="logout-button">ออกจากระบบ</a></li>
                </ul>
            </nav>
        </aside>

        <main class="admin-main">
            <header class="mobile-header">
                <div class="mobile-logo">Admin<span>.</span></div>
                <button class="mobile-menu-button" id="menu-toggle">☰</button>
            </header>

            <header class="desktop-header">
                <h1>จัดการน้องหมา</h1>
                <a href="add-item.html" class="button button-primary">เพิ่มน้องหมาตัวใหม่</a>
            </header>

            <div class="admin-card">
                <h2>รายการทั้งหมด</h2>
                <table class="product-table">
                    <thead>
                        <tr>
                            <!-- MODIFIED: New header for reorder buttons -->
                            <th class="reorder-cell">จัดลำดับ</th>
                            <th>ข้อมูลน้องหมา</th>
                            <th>สถานะ</th>
                            <th>ราคา</th>
                            <th>การกระทำ</th>
                        </tr>
                    </thead>
                    <tbody id="product-table-body">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- REMOVED SortableJS library -->
    <script src="script.js"></script>

    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, getDocs, doc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA85L7n2CGKocgWg-Z8TsNlUN9AVVJguBQ",
            authDomain: "cesarkennel.firebaseapp.com",
            projectId: "cesarkennel",
            storageBucket: "cesarkennel.firebasestorage.app",
            messagingSenderId: "512752480416",
            appId: "1:512752480416:web:c71aa9dc281a3932b419c5"
        };
        
        const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);
        const auth = getAuth(app);

        onAuthStateChanged(auth, user => {
            if (user) {
                fetchAndDisplayProducts();
            } else {
                window.location.href = 'login.html';
            }
        });

        document.getElementById('logout-button')?.addEventListener('click', (e) => {
            e.preventDefault();
            signOut(auth).then(() => {
                alert('คุณออกจากระบบแล้ว');
                window.location.href = 'index.html';
            });
        });

        function getStatusBadge(status) {
            switch (status) {
                case 'available': return '<span class="status-badge available">พร้อมขาย</span>';
                case 'preordered': return '<span class="status-badge preordered">ติดจอง</span>';
                case 'sold': return '<span class="status-badge sold">ขายแล้ว</span>';
                default: return `<span class="status-badge">${status || ''}</span>`;
            }
        }

        const fetchAndDisplayProducts = async () => {
            const tableBody = document.getElementById('product-table-body');
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">กำลังโหลดข้อมูล...</td></tr>';

            try {
                const productsRef = collection(db, "products");
                const q = query(productsRef, orderBy("orderPosition", "asc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">ยังไม่มีข้อมูลน้องหมาในระบบ</td></tr>';
                    return;
                }

                tableBody.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const product = doc.data();
                    const productId = doc.id;
                    const price = (product.price || 0).toLocaleString('th-TH');
                    const details = `${product.breed || ''} (${product.gender || ''}, ${product.color || ''})`;

                    // MODIFIED: Row template with reorder buttons
                    const row = `
                        <tr data-id="${productId}">
                            <td class="reorder-cell" data-label="จัดลำดับ">
                                <div class="reorder-buttons">
                                    <button class="button move-up-btn" title="เลื่อนขึ้น">▲</button>
                                    <button class="button move-down-btn" title="เลื่อนลง">▼</button>
                                </div>
                            </td>
                            <td data-label="ข้อมูล">
                                <div class="product-info-cell">
                                    <img src="${product.thumbnailUrl || 'https://via.placeholder.com/60'}" alt="${product.name || ''}">
                                    <div>
                                        <div class="name">${product.name || 'ไม่มีชื่อ'}</div>
                                        <div class="details">${details}</div>
                                    </div>
                                </div>
                            </td>
                            <td data-label="สถานะ">${getStatusBadge(product.status)}</td>
                            <td data-label="ราคา">${price} บาท</td>
                            <td data-label="การกระทำ">
                                <div class="action-buttons">
                                    <a href="add-item.html?id=${productId}" class="button edit-btn">แก้ไข</a>
                                    <button class="button delete-btn" data-id="${productId}" data-name="${product.name || ''}">ลบ</button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });

                // NEW: Update button states after rendering
                updateArrowButtonsState();

            } catch (error) {
                console.error("Error fetching products: ", error);
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
            }
        };

        // NEW: Function to disable/enable arrow buttons
        const updateArrowButtonsState = () => {
            const rows = document.querySelectorAll('#product-table-body tr');
            rows.forEach((row, index) => {
                const upButton = row.querySelector('.move-up-btn');
                const downButton = row.querySelector('.move-down-btn');
                if (upButton) upButton.disabled = (index === 0);
                if (downButton) downButton.disabled = (index === rows.length - 1);
            });
        };

        // MODIFIED: This function is now only for saving, not for drag-drop
        const saveNewOrder = async () => {
            const tableBody = document.getElementById('product-table-body');
            tableBody.style.opacity = '0.5'; // Visual feedback

            const batch = writeBatch(db);
            const rows = tableBody.children;

            Array.from(rows).forEach((row, index) => {
                const productId = row.dataset.id;
                if (productId) {
                    const docRef = doc(db, "products", productId);
                    batch.update(docRef, { orderPosition: index });
                }
            });

            try {
                await batch.commit();
                console.log("New order saved successfully.");
            } catch (error) {
                console.error("Error saving new order: ", error);
                alert("เกิดข้อผิดพลาดในการบันทึกลำดับใหม่!");
            } finally {
                tableBody.style.opacity = '1';
            }
        };

        // MODIFIED: Main event listener for all actions
        const tableBody = document.getElementById('product-table-body');
        tableBody.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            const currentRow = button.closest('tr');
            if (!currentRow) return;

            // Handle Move Up
            if (button.classList.contains('move-up-btn')) {
                const prevRow = currentRow.previousElementSibling;
                if (prevRow) {
                    prevRow.before(currentRow); // Move row in the DOM
                    updateArrowButtonsState(); // Update button states
                    await saveNewOrder(); // Save the new order
                }
            }

            // Handle Move Down
            if (button.classList.contains('move-down-btn')) {
                const nextRow = currentRow.nextElementSibling;
                if (nextRow) {
                    nextRow.after(currentRow); // Move row in the DOM
                    updateArrowButtonsState(); // Update button states
                    await saveNewOrder(); // Save the new order
                }
            }

            // Handle Delete
            if (button.classList.contains('delete-btn')) {
                const productId = button.dataset.id;
                const productName = button.dataset.name;

                if (confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบ "${productName}"?`)) {
                    try {
                        button.disabled = true;
                        button.textContent = 'กำลังลบ...';
                        await deleteDoc(doc(db, "products", productId));
                        currentRow.remove();
                        updateArrowButtonsState(); // Update states in case first/last item was deleted
                    } catch (error) {
                        console.error("Error deleting document: ", error);
                        alert("เกิดข้อผิดพลาดในการลบข้อมูล");
                        button.disabled = false;
                        button.textContent = 'ลบ';
                    }
                }
            }
        });
    </script>
</body>

</html>