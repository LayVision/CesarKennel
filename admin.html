<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการ - ปอมปอม บูทีค</title>
    <link rel="stylesheet" href="admin-style.css">
</head>
<body>
    <div class="admin-layout">
        <aside class="sidebar" id="sidebar">
            <div>
                <div class="sidebar-logo">Admin<span>.</span></div>
                <nav class="sidebar-nav">
                    <h3>เมนูหลัก</h3>
                    <ul>
                        <li><a href="admin.html" class="active">จัดการน้องหมา</a></li>
                        <li><a href="settings.html">ตั้งค่าเว็บไซต์</a></li>
                    </ul>
                </nav>
            </div>
             <nav class="sidebar-nav">
                <ul>
                    <li><a href="index.html">ดูหน้าร้าน</a></li>
                    <li><a href="#" class="logout-link" id="logout-button">ออกจากระบบ</a></li>
                </ul>
            </nav>
        </aside>

        <main class="admin-main">
            <header class="mobile-header">
                <div class="mobile-logo">Admin<span>.</span></div>
                <button class="mobile-menu-button" id="menu-toggle">☰</button>
            </header>
            
            <header class="desktop-header">
                <h1>จัดการน้องหมา</h1>
                <a href="add-item.html" class="button button-primary">เพิ่มน้องหมาตัวใหม่</a>
            </header>

            <div class="admin-card">
                 <h2>รายการทั้งหมด (ลากเพื่อจัดลำดับ)</h2>
                 <table class="product-table">
                     <thead>
                         <tr>
                            <th class="drag-header"></th>
                            <th>ข้อมูลน้องหมา</th>
                            <th>สถานะ</th>
                            <th>ราคา</th>
                            <th>การกระทำ</th>
                        </tr>
                     </thead>
                     <tbody id="product-table-body">
                         <!-- Data will be loaded here -->
                     </tbody>
                 </table>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="script.js"></script>

    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, getDocs, doc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA85L7n2CGKocgWg-Z8TsNlUN9AVVJguBQ",
            authDomain: "cesarkennel.firebaseapp.com",
            projectId: "cesarkennel",
            storageBucket: "cesarkennel.firebasestorage.app",
            messagingSenderId: "512752480416",
            appId: "1:512752480416:web:c71aa9dc281a3932b419c5"
        };
        
        const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);
        const auth = getAuth(app);

        onAuthStateChanged(auth, user => {
            if (user) {
                fetchAndDisplayProducts();
            } else {
                window.location.href = 'login.html';
            }
        });

        const logoutButton = document.getElementById('logout-button');
        if (logoutButton) {
            logoutButton.addEventListener('click', (e) => {
                e.preventDefault();
                signOut(auth).then(() => {
                    alert('คุณออกจากระบบแล้ว');
                    window.location.href = 'index.html';
                });
            });
        }

        function getStatusBadge(status) {
            switch (status) {
                case 'available': return '<span class="status-badge available">พร้อมขาย</span>';
                case 'preordered': return '<span class="status-badge preordered">ติดจอง</span>';
                case 'sold': return '<span class="status-badge sold">ขายแล้ว</span>';
                default: return `<span class="status-badge">${status || ''}</span>`;
            }
        }

        const fetchAndDisplayProducts = async () => {
            const tableBody = document.getElementById('product-table-body');
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">กำลังโหลดข้อมูล...</td></tr>';

            try {
                const productsRef = collection(db, "products");
                // **UPDATED QUERY**: Now sorts by the manual order
                const q = query(productsRef, orderBy("orderPosition", "asc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">ยังไม่มีข้อมูลน้องหมาในระบบ</td></tr>';
                    return;
                }

                tableBody.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const product = doc.data();
                    const productId = doc.id;
                    const price = (product.price || 0).toLocaleString('th-TH');
                    const details = `${product.breed || ''} (${product.gender || ''}, ${product.color || ''})`;
                    
                    // **UPDATED ROW**: Added data-id attribute to the <tr> element
                    const row = `
                        <tr data-id="${productId}">
                            <td><span class="drag-handle">☰</span></td>
                            <td data-label="ข้อมูล">
                                <div class="product-info-cell">
                                    <img src="${product.thumbnailUrl || 'https://via.placeholder.com/60'}" alt="${product.name || ''}">
                                    <div>
                                        <div class="name">${product.name || 'ไม่มีชื่อ'}</div>
                                        <div class="details">${details}</div>
                                    </div>
                                </div>
                            </td>
                            <td data-label="สถานะ">${getStatusBadge(product.status)}</td>
                            <td data-label="ราคา">${price} บาท</td>
                            <td data-label="การกระทำ">
                                <div class="action-buttons">
                                    <a href="add-item.html?id=${productId}" class="button edit-btn">แก้ไข</a>
                                    <button class="button delete-btn" data-id="${productId}" data-name="${product.name || ''}">ลบ</button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
                
                // Initialize SortableJS after rows are rendered
                initializeSorting(tableBody);

            } catch (error) {
                console.error("Error fetching products: ", error);
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
            }
        };

        // **NEW FUNCTION**: Saves the new order to Firestore
        const saveNewOrder = async (tableRows) => {
            const batch = writeBatch(db);
            
            Array.from(tableRows).forEach((row, index) => {
                const productId = row.dataset.id;
                if (productId) {
                    const docRef = doc(db, "products", productId);
                    batch.update(docRef, { orderPosition: index });
                }
            });

            try {
                await batch.commit();
                console.log("New order saved successfully.");
            } catch (error) {
                console.error("Error saving new order: ", error);
                alert("เกิดข้อผิดพลาดในการบันทึกลำดับใหม่!");
            }
        };

        // **NEW FUNCTION**: Initializes the SortableJS library
        const initializeSorting = (tableBody) => {
             new Sortable(tableBody, {
                handle: '.drag-handle',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: (evt) => {
                    // When the user is done dragging, save the new order.
                    const rows = evt.target.children;
                    saveNewOrder(rows);
                },
            });
        };

        const tableBody = document.getElementById('product-table-body');
        tableBody.addEventListener('click', async (e) => {
            if (e.target && e.target.classList.contains('delete-btn')) {
                const button = e.target;
                const productId = button.dataset.id;
                const productName = button.dataset.name;

                if (confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบ "${productName}"?`)) {
                    try {
                        button.disabled = true;
                        button.textContent = 'กำลังลบ...';
                        await deleteDoc(doc(db, "products", productId));
                        button.closest('tr').remove();
                    } catch (error) {
                        console.error("Error deleting document: ", error);
                        alert("เกิดข้อผิดพลาดในการลบข้อมูล");
                        button.disabled = false;
                        button.textContent = 'ลบ';
                    }
                }
            }
        });
    </script>
</body>
</html>