<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ข้อมูลสุนัข - ซีซาร์ เคนเนล</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="shop-layout">
        <!-- Main layout grid, consistent with index.html -->
        <aside class="sidebar" id="sidebar">
            <div>
                <div class="sidebar-logo">Cesar<span>.</span></div>
                <!-- MODIFIED: Menu links now point back to the filtered index page -->
                <nav class="sidebar-nav">
                    <h3>เมนู</h3>
                    <ul>
                        <li><a href="index.html">สุนัขทั้งหมด</a></li>
                        <li><a href="index.html?gender=ผู้">เพศผู้</a></li>
                        <li><a href="index.html?gender=เมีย">เพศเมีย</a></li>
                        <li><a href="#">เกี่ยวกับเรา</a></li>
                    </ul>
                </nav>
            </div>
            <div class="sidebar-footer">
                &copy; 2568 ซีซาร์ เคนเนล
                <p><a href="login.html" id="auth-link">เข้าสู่ระบบผู้ดูแล</a></p>
            </div>
        </aside>
        
        <!-- Main content area -->
        <main class="main-content" id="main-content">
            <!-- Header for mobile view -->
            <header class="mobile-header">
                <div class="mobile-logo">Cesar<span>.</span></div>
                <button class="mobile-menu-button" id="menu-toggle">☰</button>
            </header>

            <!-- Grid layout for product details, content will be loaded here -->
            <div class="product-detail-grid" id="product-detail-container">
                <!-- Loading message or dynamic content appears here -->
            </div>
        </main>
    </div> <!-- End of .shop-layout -->

    <!-- Main site footer -->
    <footer class="site-footer">
        <div class="footer-content">
            <h3 class="footer-logo">ซีซาร์ เคนเนล</h3>
            <p class="footer-description">ฟาร์มสุนัขเกรดพรีเมียม จัดส่งทั่วประเทศ</p>
            <div class="footer-contact">
                <span>โทร: 081-234-5678</span> | <span>อีเมล: contact@cesarkennel.com</span>
            </div>
            <div class="social-links">
                <a href="#" aria-label="Facebook">FB</a>
                <a href="#" aria-label="Instagram">IG</a>
                <a href="#" aria-label="Line">LINE</a>
            </div>
        </div>
    </footer>

    <!-- Link to the global JavaScript file -->
    <script src="script.js"></script>

    <!-- Main Firebase Logic for this page -->
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- Firebase Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyA85L7n2CGKocgWg-Z8TsNlUN9AVVJguBQ",
            authDomain: "cesarkennel.firebaseapp.com",
            projectId: "cesarkennel",
            storageBucket: "cesarkennel.firebasestorage.app",
            messagingSenderId: "512752480416",
            appId: "1:512752480416:web:c71aa9dc281a3932b419c5"
        };
        
        const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Manage Admin Link in Sidebar ---
        const authLink = document.getElementById('auth-link');
        onAuthStateChanged(auth, user => {
            if (user) {
                authLink.textContent = 'แผงควบคุม';
                authLink.href = 'admin.html';
            } else {
                authLink.textContent = 'เข้าสู่ระบบผู้ดูแล';
                authLink.href = 'login.html';
            }
        });
        
        // --- Main function to fetch and display product details ---
        const container = document.getElementById('product-detail-container');
        const fetchProductDetails = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (!productId) {
                container.innerHTML = '<h1>ไม่พบรหัสสินค้า</h1><p>ไม่พบข้อมูลสุนัขที่คุณต้องการ โปรดกลับไปที่<a href="index.html">หน้าร้าน</a></p>';
                return;
            }

            container.innerHTML = '<p style="text-align: center;">กำลังโหลดข้อมูล...</p>';

            try {
                const docRef = doc(db, 'products', productId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const product = docSnap.data();
                    displayProductDetails(product);
                } else {
                    container.innerHTML = '<h1>404 - ไม่พบข้อมูล</h1><p>เราไม่พบสุนัขที่คุณค้นหา อาจถูกลบไปแล้วหรือคุณมีลิงก์ที่ไม่ถูกต้อง <a href="index.html">กลับสู่หน้าร้าน</a></p>';
                    document.title = "ไม่พบข้อมูล - ซีซาร์ เคนเนล";
                }
            } catch (error) {
                console.error("Error fetching product details:", error);
                container.innerHTML = '<p style="color: red; text-align: center;">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>';
            }
        };

        // --- Helper function to populate the DOM ---
        const displayProductDetails = (product) => {
            // Set Page Title
            document.title = `${product.name} - ซีซาร์ เคนเนล`;
            
            // Button HTML
            let buttonHTML;
            if (product.status === 'sold') {
                buttonHTML = `<button class="add-to-cart-button sold-button" disabled>รายการนี้ขายแล้ว</button>`;
            } else {
                 buttonHTML = `<button class="add-to-cart-button">ติดต่อเพื่อจอง</button>`;
            }
            
            // Price HTML
            const hasDiscount = product.discountPrice > 0 && product.discountPrice < product.price;
            let priceHTML = `<span class="discounted-price">${product.price.toLocaleString('th-TH')} บาท</span>`;
            if (hasDiscount) {
                priceHTML = `
                    <span class="original-price">${product.price.toLocaleString('th-TH')}</span>
                    <span class="discounted-price">${product.discountPrice.toLocaleString('th-TH')} บาท</span>
                `;
            }

            // MODIFIED: Image Gallery HTML (Now a Slider)
            let slidesHTML = '';
            const imageUrls = product.imageUrls && product.imageUrls.length > 0 
                ? product.imageUrls 
                : ['https://via.placeholder.com/800']; // Fallback image

            imageUrls.forEach(url => {
                slidesHTML += `
                    <div class="gallery-slide">
                        <img src="${url}" alt="รูปของ ${product.name}">
                    </div>
                `;
            });

            const galleryHTML = `
                <div class="gallery-slider">
                    <div class="gallery-track" id="product-gallery-track">
                        ${slidesHTML}
                    </div>
                    <button class="gallery-arrow prev" id="product-gallery-prev">&#10094;</button>
                    <button class="gallery-arrow next" id="product-gallery-next">&#10095;</button>
                </div>
            `;

            // Final combined HTML for the grid
            container.innerHTML = `
                ${galleryHTML}
                <div class="detail-info">
                    <h1>${product.name}</h1>
                    <div class="price">${priceHTML}</div>
                    <p class="description">${product.description || 'ไม่มีคำอธิบายเพิ่มเติม'}</p>
                    
                    <ul class="details-list">
                        <li><strong>สายพันธุ์:</strong><span>${product.breed}</span></li>
                        <li><strong>อายุ:</strong><span>${product.age}</span></li>
                        <li><strong>เพศ:</strong><span>${product.gender}</span></li>
                        <li><strong>ตัวสี:</strong><span>${product.color}</span></li>
                        <li><strong>ตาสี:</strong><span>${product.eyeColor || '-'}</span></li>
                        <li><strong>วัคซีน:</strong><span>${product.vaccine || '-'}</span></li>
                    </ul>
                    ${buttonHTML}
                </div>
            `;
            
            // Initialize the new gallery slider
            initializeProductGallery();
        };
        
        // --- NEW: Function to make the product image gallery an interactive slider ---
        const initializeProductGallery = () => {
            const track = document.getElementById('product-gallery-track');
            const prevButton = document.getElementById('product-gallery-prev');
            const nextButton = document.getElementById('product-gallery-next');
            if (!track || !prevButton || !nextButton) return;

            const slides = Array.from(track.children);
            if (slides.length <= 1) {
                prevButton.style.display = 'none';
                nextButton.style.display = 'none';
                return; // No need for a slider if there's only one image
            }

            let currentIndex = 0;
            let autoSlideInterval;

            const setSlidePosition = (index) => {
                const slideWidth = slides[0].getBoundingClientRect().width;
                track.style.transform = `translateX(-${slideWidth * index}px)`;
            };

            const advanceSlide = (direction = 1) => {
                currentIndex = (currentIndex + direction + slides.length) % slides.length;
                setSlidePosition(currentIndex);
            };
            
            const startAutoSlide = () => {
                stopAutoSlide(); // Clear any existing timer
                autoSlideInterval = setInterval(() => advanceSlide(1), 5000); // 5-second interval
            };
            
            const stopAutoSlide = () => {
                clearInterval(autoSlideInterval);
            };

            nextButton.addEventListener('click', () => {
                advanceSlide(1);
                startAutoSlide(); // Reset timer on manual click
            });

            prevButton.addEventListener('click', () => {
                advanceSlide(-1);
                startAutoSlide(); // Reset timer on manual click
            });
            
            // Recalculate dimensions on window resize
            window.addEventListener('resize', () => {
                track.style.transition = 'none'; // Disable transition during resize
                setSlidePosition(currentIndex);
                // Use a timeout to re-enable transition after resize is complete
                setTimeout(() => { track.style.transition = 'transform 0.5s ease-in-out'; }, 50);
            });

            startAutoSlide(); // Start the slideshow automatically
        };


        // --- Run everything on page load ---
        fetchProductDetails();
    </script>
</body>
</html>