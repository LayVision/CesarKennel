<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ปอมปอม บูทีค</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="shop-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div>
                <div class="sidebar-logo">PomPom<span>.</span></div>
                <nav class="sidebar-nav">
                    <h3>เมนู</h3>
                    <ul>
                        <!-- Links updated for filtering -->
                        <li><a href="index.html" id="nav-all">น้องหมาทั้งหมด</a></li>
                        <li><a href="?gender=ผู้" id="nav-male">เพศผู้</a></li>
                        <li><a href="?gender=เมีย" id="nav-female">เพศเมีย</a></li>
                        <li><a href="#">เกี่ยวกับเรา</a></li>
                    </ul>
                </nav>
                <div class="sidebar-filters">
                    <h3>ตัวกรอง</h3>
                    <div class="filter-group">
                        <label for="filter-color">สี</label>
                        <select id="filter-color" name="color">
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-age">อายุ</label>
                        <select id="filter-age" name="age">
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                </div>
            </div>
            <div class="sidebar-footer">
                &copy; 2568 ปอมปอม บูทีค
                <p><a href="login.html" id="auth-link">เข้าสู่ระบบผู้ดูแล</a></p>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <header class="mobile-header">
                <div class="mobile-logo">PomPom<span>.</span></div>
                <button class="mobile-menu-button" id="menu-toggle">☰</button>
            </header>

            <section class="hero-section">
                <div class="hero-image-container">
                    <img src="https://images.pexels.com/photos/1805164/pexels-photo-1805164.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" alt="Cover Image">
                </div>
                <div class="marquee-container">
                    <p class="marquee-text">✨ น้องหมาสุขภาพดี เกรดพรีเมียม พร้อมย้ายบ้านแล้ววันนี้! ✨</p>
                </div>
            </section>

            <header class="desktop-header">
                <h1>เพื่อนคู่ใจแสนน่ารัก</h1>
                <p>น้องหมาทุกตัวถูกเลี้ยงด้วยความรัก พร้อมที่จะเป็นสมาชิกใหม่ในครอบครัวคุณ</p>
            </header>

            <div class="product-grid" id="product-grid">
                <p>กำลังโหลดข้อมูลน้องหมา...</p>
            </div>

            <div class="pagination-container" id="pagination"></div>
        </main>
    </div> <!-- End of .shop-layout -->

    <footer class="site-footer">
        <div class="footer-content">
            <h3 class="footer-logo">ปอมปอม บูทีค</h3>
            <p class="footer-description">ฟาร์มปอมเมอเรเนียนเกรดพรีเมียม จัดส่งทั่วประเทศ</p>
        </div>
    </footer>

    <!-- SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="script.js"></script>

    <script>
        // Define Firebase Config
        const firebaseConfig = {
          apiKey: "AIzaSyA85L7n2CGKocgWg-Z8TsNlUN9AVVJguBQ",
          authDomain: "cesarkennel.firebaseapp.com",
          projectId: "cesarkennel",
          storageBucket: "cesarkennel.firebasestorage.app",
          messagingSenderId: "512752480416",
          appId: "1:512752480416:web:c71aa9dc281a3932b419c5"
        };
        const app = firebase.initializeApp(firebaseConfig);

        // --- DYNAMIC AUTH LINK ---
        firebase.auth().onAuthStateChanged(function(user) {
            const authLink = document.getElementById('auth-link');
            if (user) {
                authLink.textContent = 'แผงควบคุม';
                authLink.href = 'admin.html';
            } else {
                authLink.textContent = 'เข้าสู่ระบบผู้ดูแล';
                authLink.href = 'login.html';
            }
        });

        // --- PAGE LOGIC ---
        const db = firebase.firestore();
        const productGrid = document.getElementById('product-grid');
        const paginationContainer = document.getElementById('pagination');
        const colorFilter = document.getElementById('filter-color');
        const ageFilter = document.getElementById('filter-age');

        function createDogCard(dogData, docId) {
            const card = document.createElement('a');
            card.href = `product-detail.html?id=${docId}`;
            card.className = `product-card ${dogData.status === 'sold' ? 'sold-item' : ''}`;

            let statusText = 'พร้อมย้ายบ้าน';
            if (dogData.status === 'preordered') statusText = 'ติดจอง';
            if (dogData.status === 'sold') statusText = 'ขายแล้ว';
            
            const priceHtml = dogData.discountPrice && dogData.discountPrice > 0
                ? `<span class="original-price">${dogData.price.toLocaleString()}</span> <span class="discounted-price">${dogData.discountPrice.toLocaleString()} บาท</span>`
                : `${dogData.price.toLocaleString()} บาท`;

            card.innerHTML = `
                <div class="card-image-container">
                    <span class="card-status ${dogData.status}">${statusText}</span>
                    <img src="${dogData.imageUrls && dogData.imageUrls.length > 0 ? dogData.imageUrls[0] : 'https://via.placeholder.com/400'}" alt="${dogData.name}">
                </div>
                <div class="card-content">
                    <h3>${dogData.name}</h3>
                    <div class="card-details">
                        <span>${dogData.gender}</span>
                        <span>${dogData.age}</span>
                    </div>
                    <div class="card-price">${priceHtml}</div>
                </div>
            `;
            return card;
        }

        async function fetchAndDisplayDogs(params) {
            productGrid.innerHTML = '<p>กำลังโหลดข้อมูลน้องหมา...</p>';
            let query = db.collection("dogs");

            // --- Apply Filters based on URL parameters ---
            const gender = params.get('gender');
            if (gender) {
                query = query.where('gender', '==', gender);
            }
            const color = params.get('color');
            if (color) {
                query = query.where('color', '==', color);
            }
            const age = params.get('age');
            if (age) {
                query = query.where('age', '==', age);
            }

            // --- Apply Sorting: Newest First ---
            query = query.orderBy("createdAt", "desc");

            try {
                const dogsSnapshot = await query.get();
                productGrid.innerHTML = ''; 

                if (dogsSnapshot.empty) {
                    productGrid.innerHTML = '<p>ไม่พบข้อมูลน้องหมาตามเงื่อนไขที่เลือกค่ะ</p>';
                }

                const allItems = [];
                dogsSnapshot.forEach(doc => {
                    const dogCard = createDogCard(doc.data(), doc.id);
                    productGrid.appendChild(dogCard);
                    allItems.push(dogCard);
                });
                
                setupPagination(allItems);
                // After displaying dogs, we need to populate the filters
                // To do this, we fetch ALL dogs just to get the unique filter values
                populateFilterOptions(params);
                updateActiveNav(gender);

            } catch (error) {
                console.error("Error fetching dogs: ", error);
                productGrid.innerHTML = "<p>เกิดข้อผิดพลาดในการโหลดข้อมูล โปรดลองอีกครั้ง</p>";
            }
        }
        
        async function populateFilterOptions(params) {
            const color = params.get('color');
            const age = params.get('age');
            
            const allDogsSnapshot = await db.collection("dogs").get();
            const uniqueColors = new Set();
            const uniqueAges = new Set();
            allDogsSnapshot.forEach(doc => {
                const data = doc.data();
                if(data.color) uniqueColors.add(data.color);
                if(data.age) uniqueAges.add(data.age);
            });
            
            colorFilter.innerHTML = '<option value="">ทั้งหมด</option>';
            uniqueColors.forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                if (c === color) option.selected = true;
                colorFilter.appendChild(option);
            });

            ageFilter.innerHTML = '<option value="">ทั้งหมด</option>';
            uniqueAges.forEach(a => {
                const option = document.createElement('option');
                option.value = a;
                option.textContent = a;
                if (a === age) option.selected = true;
                ageFilter.appendChild(option);
            });
        }

        function setupFilterEventListeners() {
            const handleFilterChange = () => {
                const params = new URLSearchParams(window.location.search);
                
                if (colorFilter.value) {
                    params.set('color', colorFilter.value);
                } else {
                    params.delete('color');
                }

                if (ageFilter.value) {
                    params.set('age', ageFilter.value);
                } else {
                    params.delete('age');
                }
                
                // Navigate to the new URL which will trigger a reload and re-fetch
                window.location.search = params.toString();
            };

            colorFilter.addEventListener('change', handleFilterChange);
            ageFilter.addEventListener('change', handleFilterChange);
        }
        
        function updateActiveNav(activeGender) {
            document.querySelectorAll('.sidebar-nav a').forEach(el => el.classList.remove('active'));
            if (!activeGender) {
                document.getElementById('nav-all')?.classList.add('active');
            } else if (activeGender === 'ผู้') {
                document.getElementById('nav-male')?.classList.add('active');
            } else if (activeGender === 'เมีย') {
                document.getElementById('nav-female')?.classList.add('active');
            }
        }
        
        function setupPagination(allItems) {
             const itemsPerPage = 6;
             // ... The rest of your pagination logic remains the same ...
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            fetchAndDisplayDogs(urlParams);
            setupFilterEventListeners();
        });

    </script>
</body>
</html>