<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO: Optimized title and meta description for better search engine ranking -->
    <title>ลูกสุนัขไซบีเรียน ฮัสกี้ เเละอลาสกัน มาลามิวท์ เชียงใหม่ พร้อมส่งทั่วประเทศไทย | Cesar Kennel</title>
    <meta name="description"
        content="Cesar Kennel ฟาร์มไซบีเรียน ฮัสกี้ เเละอลาสกันมาลามิวท์ เกรดคุณภาพ เชียงใหม่ เพาะพันธุ์น้องหมาสุขภาพแข็งแรง เลี้ยงดูด้วยความรัก พร้อมจัดส่งลูกสุนัขถึงบ้านคุณทั่วประเทศไทย ค้นพบน้องหมาคู่ใจวันนี้!">
    
    <!-- Open Graph Meta Tags for Social Sharing -->
    <meta property="og:title" content="ลูกสุนัขไซบีเรียน ฮัสกี้ เเละอลาสกัน มาลามิวท์ เชียงใหม่ | Cesar Kennel">
    <meta property="og:description" content="Cesar Kennel ฟาร์มไซบีเรียน ฮัสกี้ เเละอลาสกันมาลามิวท์ เกรดคุณภาพ เชียงใหม่ พร้อมจัดส่งลูกสุนัขถึงบ้านคุณทั่วประเทศไทย">
    <meta property="og:image" content="https://cesarkennel.com/cesar-kennel-logo.png">
    <meta property="og:url" content="https://cesarkennel.com">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Cesar Kennel">
    
    <link rel="stylesheet" href="style.css?v=2.0">
</head>

<body>
    <!-- Main Layout: A grid that separates the sidebar from the main content -->
    <div class="shop-layout">

        <!-- Sidebar Navigation & Social Links -->
        <aside class="sidebar" id="sidebar">
            <div>
                <div class="sidebar-logo">Cesar Kennel<span></span></div>
                <!-- Main site navigation for filtering -->
                <nav class="sidebar-nav">
                    <h3>เมนู</h3>
                    <ul>
                        <li><a href="index.html" data-filter="all">สุนัขทั้งหมด</a></li>
                        <li><a href="index.html?gender=ผู้" data-filter="ผู้">เพศผู้</a></li>
                        <li><a href="index.html?gender=เมีย" data-filter="เมีย">เพศเมีย</a></li>
                    </ul>
                </nav>
                <!-- Social media links -->
                <div class="sidebar-follow">
                    <h3>ช่องทางติดตาม</h3>
                    <ul class="sidebar-social-links" id="sidebar-social-links">
                        <!-- Links will be dynamically injected by JavaScript -->
                    </ul>
                </div>
            </div>
            <!-- Sidebar footer with copyright and admin login link -->
            <div class="sidebar-footer">
                &copy; 2568 ซีซาร์ เคนเนล
                <p><a href="login.html" id="auth-link">เข้าสู่ระบบผู้ดูแล</a></p>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Mobile Header: Visible only on smaller screens -->
            <header class="mobile-header">
                <div class="mobile-logo">Cesar Kennel<span></span></div>
                <button class="mobile-menu-button" id="menu-toggle">☰</button>
            </header>

            <!-- Hero Section: Main banner and marquee text -->
            <section class="hero-section fade-in-up">
                <div class="hero-image-container">
                    <!-- The hero image will be replaced by the one from settings if available -->
                    <img id="hero-image" src="cesar-kennel-logo.png" alt="Cesar Kennel Logo">
                    <div class="hero-text-overlay">
                        <h1>CESAR KENNEL</h1>
                        <p>ฟาร์มไซบีเรียนฮัสกี้เชียงใหม่</p>
                        <p>มีลูกสุนัขตลอดทั้งปีรวมถึงอลาสกันมาลามิวท์</p>
                        <p class="hero-price">ราคาเริ่มต้น 5,000 บาท</p>
                    </div>
                </div>
                <!-- Scrolling text banner -->
                <div class="marquee-container">
                    <p id="marquee-text-display" class="marquee-text">✨ สุนัขสุขภาพดี เกรดพรีเมียม
                        พร้อมย้ายบ้านแล้ววันนี้! ✨</p>
                </div>
            </section>

            <!-- Desktop Header: Welcome text, visible on larger screens -->
            <header class="desktop-header fade-in-up">
                <h1>เพื่อนคู่ใจที่ดีที่สุด</h1>
                <p>สุนัขทุกตัวถูกเลี้ยงด้วยความรัก พร้อมที่จะเป็นสมาชิกใหม่ในครอบครัวคุณ</p>
            </header>

            <!-- Product Grid: Container for all the dog listings -->
            <div class="product-grid" id="product-grid">
                <!-- Product cards will be loaded dynamically by JavaScript -->
            </div>

            <!-- Pagination Controls -->
            <div class="pagination-container fade-in-up" id="pagination"></div>

            <!-- Gallery Section: A slider for showcasing photos, hidden by default -->
            <section id="gallery-section" class="gallery-section fade-in-up" style="display: none;">
                <h2>✨ พบกับน้องหมาน่ารักจากฟาร์มของเราได้ที่นี่ ✨</h2>
                <div class="gallery-slider">
                    <div class="gallery-track" id="gallery-track">
                        <!-- Gallery images will be injected here by JavaScript -->
                    </div>
                    <button class="gallery-arrow prev" id="gallery-prev">&#10094;</button>
                    <button class="gallery-arrow next" id="gallery-next">&#10095;</button>
                </div>
            </section>
        </main>
    </div>

    <!-- Site Footer -->
    <footer class="site-footer">
        <div class="footer-grid">
            <!-- Footer: Info and Contact Details -->
            <div class="footer-info">
                <h3 class="footer-logo">ซีซาร์ เคนเนล</h3>
                <p class="footer-description">ฟาร์มสุนัขเกรดพรีเมียม จัดส่งทั่วประเทศ</p>
                <div class="footer-contact">
                    <span id="footer-phone"></span>
                    <span id="footer-email"></span>
                    <div id="footer-address" style="white-space: pre-line; margin-top: 1em;"></div>
                </div>
                <div class="social-links">
                    <!-- Social media icons, URLs loaded from settings -->
                    <a href="#" id="social-line" aria-label="Line" target="_blank" style="display: none;"><img
                            src="icons/line.png" alt="Line"></a>
                    <a href="#" id="social-fb" aria-label="Facebook" target="_blank" style="display: none;"><img
                            src="icons/messenger.png" alt="Facebook Messenger"></a>
                    <a href="#" id="social-tiktok" aria-label="TikTok" target="_blank" style="display: none;"><img
                            src="icons/tik-tok.png" alt="TikTok"></a>
                    <a href="#" id="social-ig" aria-label="Instagram" target="_blank" style="display: none;"><img
                            src="icons/instagram.png" alt="Instagram"></a>
                </div>
            </div>
            <!-- Footer: Embedded Google Map -->
            <div class="footer-map" id="footer-map-container">
                <!-- Google Map Iframe will be injected here by script -->
            </div>
        </div>
    </footer>


    <!-- General purpose script for mobile menu, animations, etc. -->
    <script src="script.js"></script>

    <!-- Page-specific JavaScript using Firebase -->
    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, orderBy, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Firebase configuration object
        const firebaseConfig = {
            apiKey: "AIzaSyA85L7n2CGKocgWg-Z8TsNlUN9AVVJguBQ",
            authDomain: "cesarkennel.firebaseapp.com",
            projectId: "cesarkennel",
            storageBucket: "cesarkennel.firebasestorage.app",
            messagingSenderId: "512752480416",
            appId: "1:512752480416:web:c71aa9dc281a3932b419c5"
        };

        // Initialize Firebase app (ensuring it's only initialized once)
        const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Authentication Link ---
        // Dynamically changes the login link to a control panel link if the user is authenticated
        const authLink = document.getElementById('auth-link');
        onAuthStateChanged(auth, user => {
            if (user) {
                authLink.textContent = 'แผงควบคุม';
                authLink.href = 'admin.html';
            } else {
                authLink.textContent = 'เข้าสู่ระบบผู้ดูแล';
                authLink.href = 'login.html';
            }
        });

        // --- UI Helper Functions ---
        /**
         * Updates the active state of the sidebar menu based on the current filter.
         * @param {string} filter - The active filter ('all', 'ผู้', 'เมีย').
         */
        const updateActiveMenu = (filter) => {
            const menuLinks = document.querySelectorAll('.sidebar-nav a[data-filter]');
            menuLinks.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.filter === filter) {
                    link.classList.add('active');
                }
            });
        };

        /**
         * Initializes the homepage gallery slider functionality.
         */
        const initializeGallerySlider = () => {
            const track = document.getElementById('gallery-track');
            const prevButton = document.getElementById('gallery-prev');
            const nextButton = document.getElementById('gallery-next');
            if (!track || !prevButton || !nextButton || track.children.length <= 1) return;

            let currentIndex = 0;
            let autoSlideInterval = setInterval(advanceSlide, 5000); // Auto-scroll every 5 seconds

            function advanceSlide() {
                currentIndex = (currentIndex + 1) % track.children.length;
                setSlidePosition(currentIndex);
            };

            function setSlidePosition(index) {
                const slideWidth = track.children[0].getBoundingClientRect().width;
                track.style.transform = `translateX(-${slideWidth * index}px)`;
            };

            nextButton.addEventListener('click', () => {
                advanceSlide();
                clearInterval(autoSlideInterval); // Reset timer on manual click
                autoSlideInterval = setInterval(advanceSlide, 5000);
            });

            prevButton.addEventListener('click', () => {
                currentIndex = (currentIndex - 1 + track.children.length) % track.children.length;
                setSlidePosition(currentIndex);
                clearInterval(autoSlideInterval); // Reset timer on manual click
                autoSlideInterval = setInterval(advanceSlide, 5000);
            });

            // Recalculate slide position on window resize
            window.addEventListener('resize', () => setSlidePosition(currentIndex));
        };

        // --- Data Loading ---
        /**
         * Loads global site settings from Firestore and populates the UI.
         * This includes hero image, marquee text, gallery, and all footer information.
         */
        const loadSiteSettingsAndFooter = async () => {
            const settingsRef = doc(db, "settings", "siteConfig");
            const docSnap = await getDoc(settingsRef);

            if (docSnap.exists()) {
                const data = docSnap.data();

                // Populate hero and marquee
                if (data.coverImageUrl) document.getElementById('hero-image').src = data.coverImageUrl;
                if (data.marqueeText) document.getElementById('marquee-text-display').textContent = data.marqueeText;

                // Populate homepage gallery
                const gallerySection = document.getElementById('gallery-section');
                const galleryTrack = document.getElementById('gallery-track');
                if (data.galleryImageUrls && Array.isArray(data.galleryImageUrls) && data.galleryImageUrls.length > 0) {
                    galleryTrack.innerHTML = data.galleryImageUrls.map(url =>
                        `<div class="gallery-slide"><img src="${url}" alt="Gallery Image"></div>`
                    ).join('');
                    gallerySection.style.display = 'block';
                    initializeGallerySlider();
                }

                // Populate footer contact info
                if (data.footerPhone) document.getElementById('footer-phone').textContent = `โทร: ${data.footerPhone}`;
                if (data.footerEmail) document.getElementById('footer-email').textContent = `อีเมล: ${data.footerEmail}`;
                if (data.footerAddress) document.getElementById('footer-address').textContent = data.footerAddress;

                // Populate footer and sidebar social links
                const socialLinksConfig = [
                    { id: 'social-line', url: data.socialLine, name: 'LINE', icon: 'line.png' },
                    { id: 'social-fb', url: data.socialFacebook, name: 'Facebook', icon: 'messenger.png' },
                    { id: 'social-tiktok', url: data.socialTiktok, name: 'TikTok', icon: 'tik-tok.png' },
                    { id: 'social-ig', url: data.socialInstagram, name: 'Instagram', icon: 'instagram.png' },
                ];

                let sidebarLinksHTML = '';
                socialLinksConfig.forEach(link => {
                    const footerEl = document.getElementById(link.id);
                    if (link.url) {
                        if (footerEl) {
                            footerEl.href = link.url;
                            footerEl.style.display = 'inline-block';
                        }
                        sidebarLinksHTML += `<li><a href="${link.url}" target="_blank"><img src="icons/${link.icon}" class="sidebar-social-icon" alt="${link.name}"><span>${link.name}</span></a></li>`;
                    }
                });
                document.getElementById('sidebar-social-links').innerHTML = sidebarLinksHTML;

                // Populate Google Map
                if (data.googleMapsEmbed) {
                    document.getElementById('footer-map-container').innerHTML = data.googleMapsEmbed;
                }
            }
        };

        /**
         * Fetches and displays products from Firestore based on URL parameters.
         * Handles filtering by gender and displays a message if no products are found.
         */
        const fetchAndDisplayProducts = async () => {
            const productGrid = document.getElementById('product-grid');
            productGrid.innerHTML = '<p style="text-align: center; grid-column: 1 / -1;">กำลังโหลดข้อมูลสุนัข...</p>';

            const urlParams = new URLSearchParams(window.location.search);
            const genderFilter = urlParams.get('gender');
            updateActiveMenu(genderFilter || 'all');

            try {
                // Build the Firestore query
                const productsRef = collection(db, "products");
                let q;
                if (genderFilter) {
                    q = query(productsRef, where("gender", "==", genderFilter), orderBy("orderPosition", "asc"));
                } else {
                    q = query(productsRef, orderBy("orderPosition", "asc"));
                }
                const querySnapshot = await getDocs(q);

                // Render products or a "not found" message
                if (querySnapshot.empty) {
                    productGrid.innerHTML = '<p style="text-align: center; grid-column: 1 / -1;">ตอนนี้ยังไม่มีสุนัขตรงตามเงื่อนไขค่ะ</p>';
                    return;
                }

                productGrid.innerHTML = '';
                querySnapshot.forEach(doc => {
                    productGrid.innerHTML += createProductCardHTML(doc.data(), doc.id);
                });

                // Trigger animations for the newly added cards
                if (window.observeDynamicContent) {
                    window.observeDynamicContent('.product-card');
                }

                // Setup pagination after products are loaded
                initializePagination();

            } catch (error) {
                console.error("Error fetching products:", error);
                productGrid.innerHTML = '<p style="color: red; text-align: center; grid-column: 1 / -1;">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>';
            }
        };

        /**
         * Creates the HTML string for a single product card.
         * @param {object} product - The product data object from Firestore.
         * @param {string} id - The Firestore document ID.
         * @returns {string} The HTML string for the product card.
         */
        const createProductCardHTML = (product, id) => {
            const isSold = product.status === 'sold';
            const price = product.price || 0;
            const discountPrice = product.discountPrice || 0;
            const hasDiscount = discountPrice > 0 && discountPrice < price;

            // Generate price HTML, showing discount if available
            let priceHTML = hasDiscount ? `
                <div class="card-price">
                    <span class="original-price">${price.toLocaleString('th-TH')}</span>
                    <span class="discounted-price">${discountPrice.toLocaleString('th-TH')} บาท</span>
                </div>` :
                `<div class="card-price">${price.toLocaleString('th-TH')} บาท</div>`;

            // Map status to CSS class and text
            const statusMap = {
                available: { class: 'available', text: 'พร้อมย้ายบ้าน' },
                preordered: { class: 'preordered', text: 'ติดจอง' },
                sold: { class: 'sold', text: 'ขายแล้ว' }
            };
            const statusInfo = statusMap[product.status] || statusMap.available;

            return `
                <a href="product-detail.html?id=${id}" class="product-card ${isSold ? 'sold-item' : ''}">
                    <div class="card-image-container">
                        <span class="card-status ${statusInfo.class}">${statusInfo.text}</span>
                        <img src="${product.thumbnailUrl || 'https://via.placeholder.com/400'}" alt="${product.name || 'สุนัข'}">
                    </div>
                    <div class="card-content">
                        <h3>${product.name || 'ไม่มีชื่อ'}</h3>
                        <div class="card-details">
                            <span>เพศ${product.gender || '-'}</span>
                            <span>${product.age || '-'}</span>
                        </div>
                        ${priceHTML}
                    </div>
                </a>`;
        };

        // --- Pagination ---
        /**
         * Initializes pagination based on the number of product cards.
         * It calculates pages, displays items for the current page, and generates page buttons.
         */
        const initializePagination = () => {
            const paginationContainer = document.getElementById('pagination');
            const productGrid = document.getElementById('product-grid');
            if (!productGrid || !paginationContainer) return;

            // Adjust items per page for tablet viewports
            const isTablet = window.matchMedia("(min-width: 768px) and (max-width: 1199px)").matches;
            const itemsPerPage = isTablet ? 9 : 8;
            const allItems = Array.from(productGrid.getElementsByClassName('product-card'));

            // Hide pagination if not needed
            if (allItems.length <= itemsPerPage) {
                paginationContainer.innerHTML = '';
                allItems.forEach(item => item.style.display = 'block');
                return;
            };

            const totalPages = Math.ceil(allItems.length / itemsPerPage);

            function displayPage(page) {
                page = Math.max(1, Math.min(page, totalPages)); // Clamp page number
                const startIndex = (page - 1) * itemsPerPage;
                allItems.forEach((item, index) => {
                    item.style.display = (index >= startIndex && index < startIndex + itemsPerPage) ? 'block' : 'none';
                });
                updatePaginationButtons(page, totalPages);
            }

            function updatePaginationButtons(currentPage, totalPages) {
                paginationContainer.innerHTML = '';
                const createButton = (text, page, isDisabled = false, isActive = false) => {
                    const btn = document.createElement('a');
                    btn.className = `page-btn ${isDisabled ? 'disabled' : ''} ${isActive ? 'active' : ''}`;
                    btn.textContent = text;
                    if (!isDisabled) {
                        const urlParams = new URLSearchParams(window.location.search);
                        urlParams.set('page', page);
                        btn.href = `?${urlParams.toString()}`;
                    }
                    return btn;
                };

                paginationContainer.appendChild(createButton('ก่อนหน้า', currentPage - 1, currentPage === 1));
                for (let i = 1; i <= totalPages; i++) {
                    paginationContainer.appendChild(createButton(i, i, false, i === currentPage));
                }
                paginationContainer.appendChild(createButton('ถัดไป', currentPage + 1, currentPage === totalPages));
            }

            const initialPage = parseInt(new URLSearchParams(window.location.search).get('page')) || 1;
            displayPage(initialPage);
        };

        // Re-initialize pagination on window resize to handle responsive item counts
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(initializePagination, 250);
        });

        // --- Initial Load ---
        loadSiteSettingsAndFooter();
        fetchAndDisplayProducts();
    </script>
</body>

</html>