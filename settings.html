<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตั้งค่าเว็บไซต์ - ซีซาร์ เคนเนล</title>
    <link rel="stylesheet" href="admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
</head>
<body>
    <div class="admin-layout">
        <aside class="sidebar" id="sidebar">
            <div>
                <div class="sidebar-logo">Admin<span>.</span></div>
                <nav class="sidebar-nav">
                    <h3>เมนูหลัก</h3>
                    <ul>
                        <li><a href="admin.html">จัดการสุนัข</a></li>
                        <li><a href="settings.html" class="active">ตั้งค่าเว็บไซต์</a></li>
                    </ul>
                </nav>
            </div>
             <nav class="sidebar-nav">
                <ul>
                    <li><a href="index.html">ดูหน้าร้าน</a></li>
                    <li><a href="#" class="logout-link" id="logout-button">ออกจากระบบ</a></li>
                </ul>
            </nav>
        </aside>

        <main class="admin-main">
            <header class="mobile-header">
                <div class="mobile-logo">Admin<span>.</span></div>
                <button class="mobile-menu-button" id="menu-toggle">☰</button>
            </header>
            
            <header class="desktop-header">
                <h1>ตั้งค่าเว็บไซต์</h1>
            </header>

            <form id="settings-form" class="admin-card">
                <h2>ปรับแต่งหน้าแรก</h2>
                <div class="form-grid">
                    <div class="input-group full-width">
                        <label for="cover-image-upload">รูปภาพหน้าปก (จะแสดงแทนที่โลโก้)</label>
                        <input type="file" id="cover-image-upload" name="cover-image" accept="image/*">
                    </div>
                    <div class="input-group full-width">
                        <label for="marquee-text">ข้อความวิ่ง</label>
                        <input type="text" id="marquee-text" name="marquee-text" value="✨ สุนัขสุขภาพดี เกรดพรีเมียม พร้อมย้ายบ้านแล้ววันนี้! ✨">
                    </div>
                </div>

                <!-- NEW: TikTok Embed Section -->
                <h2 class="form-section-header">วิดีโอ TikTok ล่าสุด</h2>
                <div class="form-grid">
                    <div class="input-group full-width">
                        <label for="tiktok-embed-1">โค้ดสำหรับฝังวิดีโอ TikTok #1 (ใหม่สุด)</label>
                        <textarea id="tiktok-embed-1" name="tiktok-embed-1" rows="4" placeholder="วางโค้ด <blockquote ...> ที่คัดลอกจาก TikTok ที่นี่"></textarea>
                    </div>
                    <div class="input-group full-width">
                        <label for="tiktok-embed-2">โค้ดสำหรับฝังวิดีโอ TikTok #2</label>
                        <textarea id="tiktok-embed-2" name="tiktok-embed-2" rows="4" placeholder="วางโค้ด <blockquote ...> ที่คัดลอกจาก TikTok ที่นี่"></textarea>
                    </div>
                    <div class="input-group full-width">
                        <label for="tiktok-embed-3">โค้ดสำหรับฝังวิดีโอ TikTok #3</label>
                        <textarea id="tiktok-embed-3" name="tiktok-embed-3" rows="4" placeholder="วางโค้ด <blockquote ...> ที่คัดลอกจาก TikTok ที่นี่"></textarea>
                    </div>
                </div>


                <div class="form-actions full-width">
                   <button type="submit" class="button button-primary">บันทึกการตั้งค่าทั้งหมด</button>
               </div>
            </form>
        </main>
    </div>

    <div id="crop-modal" class="crop-modal">
        <div class="crop-modal-content">
            <h3>ตัดรูปภาพหน้าปก</h3>
            <div class="crop-image-container">
                <img id="image-to-crop" src="">
            </div>
            <div class="crop-modal-actions">
                <button type="button" id="cancel-crop-btn" class="button button-secondary">ยกเลิก</button>
                <button type="button" id="crop-btn" class="button button-primary">ตัดและใช้งานรูปนี้</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA85L7n2CGKocgWg-Z8TsNlUN9AVVJguBQ",
            authDomain: "cesarkennel.firebaseapp.com",
            projectId: "cesarkennel",
            storageBucket: "cesarkennel.firebasestorage.app",
            messagingSenderId: "512752480416",
            appId: "1:512752480416:web:c71aa9dc281a3932b419c5"
        };
        
        const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);
        const auth = getAuth(app);
        const IMG_BB_API_KEY = '2c1b183962c1d06f8aecea08cbc78d11';

        onAuthStateChanged(auth, user => { if (!user) window.location.href = 'login.html' });
        document.getElementById('logout-button')?.addEventListener('click', (e) => {
            e.preventDefault();
            signOut(auth).then(() => {
                alert('คุณออกจากระบบแล้ว');
                window.location.href = 'index.html';
            });
        });

        const settingsForm = document.getElementById('settings-form');
        const coverImageInput = document.getElementById('cover-image-upload');
        const marqueeTextInput = document.getElementById('marquee-text');
        // MODIFIED: Added TikTok inputs
        const tiktokEmbed1 = document.getElementById('tiktok-embed-1');
        const tiktokEmbed2 = document.getElementById('tiktok-embed-2');
        const tiktokEmbed3 = document.getElementById('tiktok-embed-3');
        const settingsRef = doc(db, "settings", "siteConfig");

        const cropModal = document.getElementById('crop-modal');
        const imageToCrop = document.getElementById('image-to-crop');
        const cropBtn = document.getElementById('crop-btn');
        const cancelCropBtn = document.getElementById('cancel-crop-btn');
        let cropper = null;
        let croppedBlob = null;

        const loadCurrentSettings = async () => {
            const docSnap = await getDoc(settingsRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.marqueeText) marqueeTextInput.value = data.marqueeText;
                // MODIFIED: Load TikTok embed codes
                if (data.tiktokEmbed1) tiktokEmbed1.value = data.tiktokEmbed1;
                if (data.tiktokEmbed2) tiktokEmbed2.value = data.tiktokEmbed2;
                if (data.tiktokEmbed3) tiktokEmbed3.value = data.tiktokEmbed3;
            }
        };
        loadCurrentSettings();

        coverImageInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files && files.length > 0) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imageToCrop.src = event.target.result;
                    cropModal.style.display = 'flex';
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(imageToCrop, { aspectRatio: 16 / 9, viewMode: 1, background: false });
                };
                reader.readAsDataURL(files[0]);
            }
        });

        cropBtn.addEventListener('click', () => {
            if (cropper) {
                cropper.getCroppedCanvas({ width: 1280, height: 720 }).toBlob((blob) => {
                    croppedBlob = blob;
                    alert('ตัดรูปภาพเรียบร้อย! กด "บันทึกการตั้งค่าทั้งหมด" เพื่อยืนยัน');
                    closeCropModal();
                }, 'image/jpeg');
            }
        });

        cancelCropBtn.addEventListener('click', closeCropModal);

        function closeCropModal() {
            cropModal.style.display = 'none';
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            coverImageInput.value = '';
        }

        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = settingsForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'กำลังบันทึก...';

            try {
                let coverImageUrl = null;
                if (croppedBlob) {
                     coverImageUrl = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => {
                            const base64String = reader.result.split(',')[1];
                            const body = new URLSearchParams();
                            body.append('image', base64String);
                            fetch(`https://api.imgbb.com/1/upload?key=${IMG_BB_API_KEY}`, { method: 'POST', body: body })
                            .then(res => res.json())
                            .then(result => result.success ? resolve(result.data.url) : reject(new Error(result.error?.message || `Image upload failed`)))
                            .catch(reject);
                        };
                        reader.onerror = error => reject(error);
                        reader.readAsDataURL(croppedBlob);
                    });
                }

                // MODIFIED: Prepare data with TikTok fields
                const settingsData = {
                    marqueeText: marqueeTextInput.value,
                    tiktokEmbed1: tiktokEmbed1.value,
                    tiktokEmbed2: tiktokEmbed2.value,
                    tiktokEmbed3: tiktokEmbed3.value,
                };

                if (coverImageUrl) {
                    settingsData.coverImageUrl = coverImageUrl;
                }

                await setDoc(settingsRef, settingsData, { merge: true });

                alert('บันทึกการตั้งค่าสำเร็จ!');
                croppedBlob = null;
                coverImageInput.value = '';

            } catch (error) {
                console.error('Error saving settings: ', error);
                alert(`เกิดข้อผิดพลาด: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'บันทึกการตั้งค่าทั้งหมด';
            }
        });
    </script>
</body>
</html>