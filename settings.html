<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตั้งค่าเว็บไซต์ - ปอมปอม บูทีค</title>
    <link rel="stylesheet" href="admin-style.css">
</head>
<body>
    <!-- Main admin layout -->
    <div class="admin-layout">
        <!-- Sidebar for admin navigation -->
        <aside class="sidebar" id="sidebar">
            <div>
                <div class="sidebar-logo">Admin<span>.</span></div>
                <nav class="sidebar-nav">
                    <h3>เมนูหลัก</h3>
                    <ul>
                        <li><a href="admin.html">จัดการน้องหมา</a></li>
                        <li><a href="settings.html" class="active">ตั้งค่าเว็บไซต์</a></li>
                    </ul>
                </nav>
            </div>
             <nav class="sidebar-nav">
                <ul>
                    <li><a href="index.html">ดูหน้าร้าน</a></li>
                    <li><a href="#" class="logout-link" id="logout-button">ออกจากระบบ</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main content area for settings -->
        <main class="admin-main">
            <!-- Header for mobile view -->
            <header class="mobile-header">
                <div class="mobile-logo">Admin<span>.</span></div>
                <button class="mobile-menu-button" id="menu-toggle">☰</button>
            </header>
            
            <!-- Header for desktop view -->
            <header class="desktop-header">
                <h1>ตั้งค่าเว็บไซต์</h1>
            </header>

            <!-- Form containing all website settings, within a card -->
            <form id="settings-form" class="admin-card">
                <!-- 1. Homepage Customization -->
                <h2>ปรับแต่งหน้าแรก</h2>
                <div class="form-grid">
                    <div class="input-group full-width">
                        <label for="cover-image-upload">รูปภาพหน้าปก (หากไม่ต้องการเปลี่ยน ให้เว้นว่างไว้)</label>
                        <input type="file" id="cover-image-upload" name="cover-image" accept="image/*">
                    </div>
                    <div class="input-group full-width">
                        <label for="marquee-text">ข้อความวิ่ง</label>
                        <input type="text" id="marquee-text" name="marquee-text" value="✨ น้องหมาสุขภาพดี เกรดพรีเมียม พร้อมย้ายบ้านแล้ววันนี้! ✨">
                    </div>
                </div>

                <!-- Form submission button -->
                <div class="form-actions full-width">
                   <button type="submit" class="button button-primary">บันทึกการตั้งค่าทั้งหมด</button>
               </div>
            </form>
        </main>
    </div>
    <!-- Link to the main JavaScript file -->
    <script src="script.js"></script>

    <!-- NEW: Script to handle settings save -->
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA85L7n2CGKocgWg-Z8TsNlUN9AVVJguBQ",
            authDomain: "cesarkennel.firebaseapp.com",
            projectId: "cesarkennel",
            storageBucket: "cesarkennel.firebasestorage.app",
            messagingSenderId: "512752480416",
            appId: "1:512752480416:web:c71aa9dc281a3932b419c5"
        };
        
        const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);
        const auth = getAuth(app);
        const IMG_BB_API_KEY = '2c1b183962c1d06f8aecea08cbc78d11';

        // Auth check
        onAuthStateChanged(auth, user => { if (!user) window.location.href = 'login.html' });
        document.getElementById('logout-button')?.addEventListener('click', (e) => {
            e.preventDefault();
            signOut(auth).then(() => {
                alert('คุณออกจากระบบแล้ว');
                window.location.href = 'index.html';
            });
        });

        const settingsForm = document.getElementById('settings-form');
        const coverImageInput = document.getElementById('cover-image-upload');
        const marqueeTextInput = document.getElementById('marquee-text');
        const settingsRef = doc(db, "settings", "siteConfig");

        // Load existing settings when the page loads
        const loadCurrentSettings = async () => {
            const docSnap = await getDoc(settingsRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.marqueeText) {
                    marqueeTextInput.value = data.marqueeText;
                }
                // We don't need to load the image, just show the text
            }
        };
        loadCurrentSettings();

        // Handle form submission
        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = settingsForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'กำลังบันทึก...';

            try {
                const file = coverImageInput.files[0];
                let coverImageUrl = null;

                // 1. If a new image is selected, upload it
                if (file) {
                    const formData = new FormData();
                    formData.append('image', file);
                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMG_BB_API_KEY}`, { method: 'POST', body: formData });
                    const result = await response.json();
                    if (result.success) {
                        coverImageUrl = result.data.url;
                    } else {
                        throw new Error(`Image upload failed: ${result.error.message}`);
                    }
                }

                // 2. Prepare data to save to Firestore
                const settingsData = {
                    marqueeText: marqueeTextInput.value
                };

                if (coverImageUrl) {
                    settingsData.coverImageUrl = coverImageUrl;
                }

                // 3. Save data to Firestore using setDoc with merge
                // This creates the document if it doesn't exist, or updates it without overwriting fields you don't provide.
                await setDoc(settingsRef, settingsData, { merge: true });

                alert('บันทึกการตั้งค่าสำเร็จ!');

            } catch (error) {
                console.error('Error saving settings: ', error);
                alert(`เกิดข้อผิดพลาด: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'บันทึกการตั้งค่าทั้งหมด';
            }
        });
    </script>
</body>
</html>