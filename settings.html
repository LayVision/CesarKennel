<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO: noindex tag prevents search engines from indexing this admin page -->
    <meta name="robots" content="noindex, nofollow">
    <title>ตั้งค่าเว็บไซต์ - ซีซาร์ เคนเนล</title>
    <link rel="stylesheet" href="admin-style.css">
    <!-- Third-party library for image cropping -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
</head>

<body>
    <!-- Main Layout: A grid that separates the sidebar from the main content -->
    <div class="admin-layout">

        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div>
                <div class="sidebar-logo">Admin<span>.</span></div>
                <nav class="sidebar-nav">
                    <h3>เมนูหลัก</h3>
                    <ul>
                        <li><a href="admin.html">จัดการสุนัข</a></li>
                        <li><a href="settings.html" class="active">ตั้งค่าเว็บไซต์</a></li>
                    </ul>
                </nav>
                <!-- START OF ADDED SECTION -->
                <nav class="sidebar-nav">
                    <h3>บัญชีผู้ใช้</h3>
                    <ul>
                        <li><a href="change-password.html">เปลี่ยนรหัสผ่าน</a></li>
                    </ul>
                </nav>
                <!-- END OF ADDED SECTION -->
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="index.html">ดูหน้าร้าน</a></li>
                    <li><a href="#" class="logout-link" id="logout-button">ออกจากระบบ</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Admin Content Area -->
        <main class="admin-main">
            <!-- Mobile Header: Visible only on smaller screens -->
            <header class="mobile-header">
                <div class="mobile-logo">Admin<span>.</span></div>
                <button class="mobile-menu-button" id="menu-toggle">☰</button>
            </header>

            <!-- Desktop Header: Visible on larger screens -->
            <header class="desktop-header">
                <h1>ตั้งค่าเว็บไซต์</h1>
            </header>

            <!-- Settings Form -->
            <form id="settings-form" class="admin-card">
                <!-- Section: Homepage Customization -->
                <h2>ปรับแต่งหน้าแรก</h2>
                <div class="form-grid">
                    <div class="input-group full-width">
                        <label for="cover-image-upload" class="image-upload-area">
                            <div class="upload-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-image"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                            </div>
                            <span class="upload-main-text">กดเพื่ออัพโหลดรูปภาพหน้าปก</span>
                            <span class="upload-sub-text">จะแสดงแทนที่โลโก้ (แนะนำอัตราส่วน 16:9)</span>
                        </label>
                        <input type="file" id="cover-image-upload" name="cover-image" accept="image/*" style="display: none;">
                    </div>
                    <div class="input-group full-width">
                        <label for="marquee-text">ข้อความวิ่ง</label>
                        <input type="text" id="marquee-text" name="marquee-text"
                            value="✨ สุนัขสุขภาพดี เกรดพรีเมียม พร้อมย้ายบ้านแล้ววันนี้! ✨">
                    </div>
                </div>

                <!-- Section: Contact Links for Product Page -->
                <h2 class="form-section-header">ลิงก์สำหรับติดต่อ (หน้าสินค้า)</h2>
                <div class="form-grid">
                    <div class="input-group full-width">
                        <label for="line-url">LINE Contact URL</label>
                        <input type="url" id="line-url" name="line-url" placeholder="เช่น https://line.me/ti/p/...">
                    </div>
                    <div class="input-group full-width">
                        <label for="messenger-url">Facebook Messenger URL</label>
                        <input type="url" id="messenger-url" name="messenger-url"
                            placeholder="เช่น https://m.me/yourpage">
                    </div>
                </div>

                <!-- Section: Footer Information -->
                <h2 class="form-section-header">ข้อมูลส่วนท้ายเว็บ (Footer)</h2>
                <div class="form-grid">
                    <div class="input-group"><label for="footer-phone">เบอร์โทรศัพท์</label><input type="text"
                            id="footer-phone" name="footer-phone" placeholder="เช่น 081-234-5678"></div>
                    <div class="input-group"><label for="footer-email">อีเมล</label><input type="email"
                            id="footer-email" name="footer-email" placeholder="เช่น contact@cesarkennel.com"></div>
                    <div class="input-group full-width">
                        <label for="footer-address">ที่อยู่</label>
                        <textarea id="footer-address" name="footer-address" rows="3"
                            placeholder="ใส่ที่อยู่ ที่นี่">79 เเม่ปูคา สันกำเเพง อ. สันกำแพง เชียงใหม่ 50310</textarea>
                    </div>
                    <div class="input-group"><label for="social-facebook">Facebook URL</label><input type="url"
                            id="social-facebook" name="social-facebook" placeholder="https://facebook.com/yourpage">
                    </div>
                    <div class="input-group"><label for="social-instagram">Instagram URL</label><input type="url"
                            id="social-instagram" name="social-instagram"
                            placeholder="https://instagram.com/yourprofile"></div>
                    <div class="input-group"><label for="social-line">LINE URL</label><input type="url" id="social-line"
                            name="social-line" placeholder="https://line.me/ti/p/..."></div>
                    <div class="input-group"><label for="social-tiktok">TikTok URL</label><input type="url"
                            id="social-tiktok" name="social-tiktok" placeholder="https://tiktok.com/@yourprofile"></div>
                    <div class="input-group full-width">
                        <label for="google-maps-embed">Google Maps Embed Code (HTML)</label>
                        <textarea id="google-maps-embed" name="google-maps-embed" rows="4"
                            placeholder="วางโค้ด<iframe> จาก Google Maps ที่นี่"><iframe src="https://www.google.com/maps/embed?pb=!1m14!1m8!1m3!d60440.021145593804!2d99.110425!3d18.775799!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x30da27a492d61e43%3A0xa3a918912c35cd86!2zQ2VzYXIgRG9nIGNhcmUg4Lij4Lix4Lia4Lid4Liy4LiB4Liq4Li44LiZ4Lix4LiC4LmA4LiK4Li14Lii4LiH4LmD4Lir4Lih4LmI!5e0!3m2!1sen!2sus!4v1755346701144!5m2!1sen!2sus" width="600" height="450" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe></textarea>
                    </div>
                </div>

                <!-- Section: Homepage Gallery -->
                <h2 class="form-section-header">แกลเลอรี่หน้าแรก (ลากเพื่อจัดลำดับ, สูงสุด 10 รูป)</h2>
                <div class="input-group full-width">
                    <label for="gallery-image-upload" class="image-upload-area">
                        <div class="upload-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-image"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                        </div>
                        <span class="upload-main-text">กดเพื่ออัพโหลดรูปภาพแกลเลอรี่</span>
                        <span class="upload-sub-text">PNG, JPEG, JPG</span>
                    </label>
                    <input type="file" id="gallery-image-upload" multiple accept="image/*" style="display: none;">
                </div>
                <div id="gallery-preview-container" class="image-preview-container">
                    <!-- Gallery image previews will be generated here -->
                </div>

                <!-- Form Submission Button -->
                <div class="form-actions full-width">
                    <button type="submit" class="button button-primary">บันทึกการตั้งค่าทั้งหมด</button>
                </div>
            </form>
        </main>
    </div>

    <!-- Modal for Image Cropping -->
    <div id="crop-modal" class="crop-modal">
        <div class="crop-modal-content">
            <h3>ตัดรูปภาพหน้าปก</h3>
            <div class="crop-image-container">
                <img id="image-to-crop" src="">
            </div>
            <div class="crop-modal-actions">
                <button type="button" id="cancel-crop-btn" class="button button-secondary">ยกเลิก</button>
                <button type="button" id="crop-btn" class="button button-primary">ตัดและใช้งานรูปนี้</button>
            </div>
        </div>
    </div>

    <!-- General purpose script for mobile menu, etc. -->
    <script src="script.js"></script>
    <!-- Third-party libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <!-- Page-specific JavaScript using Firebase -->
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA85L7n2CGKocgWg-Z8TsNlUN9AVVJguBQ",
            authDomain: "cesarkennel.firebaseapp.com",
            projectId: "cesarkennel",
            storageBucket: "cesarkennel.firebasestorage.app",
            messagingSenderId: "512752480416",
            appId: "1:512752480416:web:c71aa9dc281a3932b419c5"
        };

        const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);
        const auth = getAuth(app);
        const IMG_BB_API_KEY = '2c1b183962c1d06f8aecea08cbc78d11';

        // --- Authentication ---
        onAuthStateChanged(auth, user => { if (!user) window.location.href = 'login.html' });
        document.getElementById('logout-button')?.addEventListener('click', (e) => {
            e.preventDefault();
            signOut(auth).then(() => {
                alert('คุณออกจากระบบแล้ว');
                window.location.href = 'index.html';
            });
        });

        // --- DOM Elements ---
        const settingsForm = document.getElementById('settings-form');
        const settingsRef = doc(db, "settings", "siteConfig");
        // Form inputs
        const coverImageInput = document.getElementById('cover-image-upload');
        const marqueeTextInput = document.getElementById('marquee-text');
        const lineUrlInput = document.getElementById('line-url');
        const messengerUrlInput = document.getElementById('messenger-url');
        const footerPhoneInput = document.getElementById('footer-phone');
        const footerEmailInput = document.getElementById('footer-email');
        const footerAddressInput = document.getElementById('footer-address');
        const socialFacebookInput = document.getElementById('social-facebook');
        const socialInstagramInput = document.getElementById('social-instagram');
        const socialLineInput = document.getElementById('social-line');
        const socialTiktokInput = document.getElementById('social-tiktok');
        const googleMapsEmbedInput = document.getElementById('google-maps-embed');
        // Gallery elements
        const galleryImageInput = document.getElementById('gallery-image-upload');
        const galleryPreviewContainer = document.getElementById('gallery-preview-container');
        const newGalleryFilesMap = new Map();
        // Cropper modal elements
        const cropModal = document.getElementById('crop-modal');
        const imageToCrop = document.getElementById('image-to-crop');
        const cropBtn = document.getElementById('crop-btn');
        const cancelCropBtn = document.getElementById('cancel-crop-btn');
        let cropper = null;
        let croppedBlob = null; // Stores the cropped image data before upload

        // --- Gallery Preview Management ---
        const createGalleryPreviewElement = (id, src, isExisting = false) => {
            if (galleryPreviewContainer.children.length >= 10) {
                alert('คุณสามารถอัปโหลดรูปภาพแกลเลอรี่ได้สูงสุด 10 รูป');
                return;
            }
            const wrapper = document.createElement('div');
            wrapper.className = 'image-preview-item';
            wrapper.dataset.id = id;
            if (isExisting) wrapper.dataset.url = src;
            wrapper.innerHTML = `
                <span class="drag-handle">☰</span><img src="${src}" alt="Gallery preview"><button type="button" class="remove-btn" title="Remove image">&times;</button>`;
            galleryPreviewContainer.appendChild(wrapper);
        };
        galleryImageInput.addEventListener('change', (e) => {
            for (const file of e.target.files) {
                if (galleryPreviewContainer.children.length >= 10) break;
                const uniqueId = `${Date.now()}-${file.name}`;
                newGalleryFilesMap.set(uniqueId, file);
                const reader = new FileReader();
                reader.onload = (event) => createGalleryPreviewElement(uniqueId, event.target.result, false);
                reader.readAsDataURL(file);
            }
            e.target.value = '';
        });
        galleryPreviewContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-btn')) {
                const wrapper = e.target.closest('.image-preview-item');
                if (wrapper) {
                    newGalleryFilesMap.delete(wrapper.dataset.id);
                    wrapper.remove();
                }
            }
        });
        new Sortable(galleryPreviewContainer, { animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost' });

        // --- Load Existing Settings ---
        const loadCurrentSettings = async () => {
            const docSnap = await getDoc(settingsRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                marqueeTextInput.value = data.marqueeText || '';
                lineUrlInput.value = data.lineUrl || '';
                messengerUrlInput.value = data.messengerUrl || '';
                footerPhoneInput.value = data.footerPhone || '';
                footerEmailInput.value = data.footerEmail || '';
                footerAddressInput.value = data.footerAddress || '';
                socialFacebookInput.value = data.socialFacebook || '';
                socialInstagramInput.value = data.socialInstagram || '';
                socialLineInput.value = data.socialLine || '';
                socialTiktokInput.value = data.socialTiktok || '';
                googleMapsEmbedInput.value = data.googleMapsEmbed || '';

                if (data.galleryImageUrls && Array.isArray(data.galleryImageUrls)) {
                    data.galleryImageUrls.forEach(url => createGalleryPreviewElement(url, url, true));
                }
            }
        };

        // --- Image Cropper Logic ---
        coverImageInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files && files.length > 0) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imageToCrop.src = event.target.result;
                    cropModal.style.display = 'flex';
                    if (cropper) cropper.destroy();
                    // Initialize Cropper.js with a 16:9 aspect ratio
                    cropper = new Cropper(imageToCrop, { aspectRatio: 16 / 9, viewMode: 1, background: false });
                };
                reader.readAsDataURL(files[0]);
            }
        });
        cropBtn.addEventListener('click', () => {
            if (cropper) {
                cropper.getCroppedCanvas({ width: 1280, height: 720 }).toBlob((blob) => {
                    croppedBlob = blob; // Store the result
                    alert('ตัดรูปภาพเรียบร้อย! กด "บันทึกการตั้งค่าทั้งหมด" เพื่อยืนยัน');
                    closeCropModal();
                }, 'image/jpeg');
            }
        });
        cancelCropBtn.addEventListener('click', closeCropModal);
        function closeCropModal() {
            cropModal.style.display = 'none';
            if (cropper) cropper.destroy();
            cropper = null;
            coverImageInput.value = '';
        }

        // --- Form Submission ---
        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = settingsForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'กำลังบันทึก...';

            try {
                // 1. Upload cropped cover image if it exists
                let coverImageUrl = null;
                if (croppedBlob) {
                    coverImageUrl = await uploadImage(croppedBlob);
                }

                // 2. Handle gallery images
                const galleryItems = Array.from(galleryPreviewContainer.querySelectorAll('.image-preview-item'));
                const galleryUploadPromises = galleryItems.map(item => {
                    if (item.dataset.url) return Promise.resolve(item.dataset.url); // Existing image
                    const file = newGalleryFilesMap.get(item.dataset.id);
                    return file ? uploadImage(file) : Promise.resolve(null); // New image
                });
                const finalGalleryImageUrls = (await Promise.all(galleryUploadPromises)).filter(Boolean);

                // 3. Construct settings data object
                const settingsData = {
                    marqueeText: marqueeTextInput.value,
                    lineUrl: lineUrlInput.value,
                    messengerUrl: messengerUrlInput.value,
                    galleryImageUrls: finalGalleryImageUrls,
                    footerPhone: footerPhoneInput.value,
                    footerEmail: footerEmailInput.value,
                    footerAddress: footerAddressInput.value,
                    socialFacebook: socialFacebookInput.value,
                    socialInstagram: socialInstagramInput.value,
                    socialLine: socialLineInput.value,
                    socialTiktok: socialTiktokInput.value,
                    googleMapsEmbed: googleMapsEmbedInput.value
                };
                if (coverImageUrl) settingsData.coverImageUrl = coverImageUrl;

                // 4. Save to Firestore
                await setDoc(settingsRef, settingsData, { merge: true });

                alert('บันทึกการตั้งค่าสำเร็จ!');
                croppedBlob = null; // Reset state
                coverImageInput.value = '';

            } catch (error) {
                console.error('Error saving settings: ', error);
                alert(`เกิดข้อผิดพลาด: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'บันทึกการตั้งค่าทั้งหมด';
            }
        });

        /**
         * Generic function to upload an image file/blob to ImgBB.
         * @param {Blob|File} imageBlob - The image data to upload.
         * @returns {Promise<string>} A promise that resolves with the image URL.
         */
        function uploadImage(imageBlob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    const body = new URLSearchParams();
                    body.append('image', base64String);
                    fetch(`https://api.imgbb.com/1/upload?key=${IMG_BB_API_KEY}`, { method: 'POST', body: body })
                        .then(res => res.json())
                        .then(result => result.success ? resolve(result.data.url) : reject(new Error(result.error?.message || `Image upload failed`)))
                        .catch(reject);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(imageBlob);
            });
        }

        // Initial load of settings when page opens
        loadCurrentSettings();
    </script>
</body>

</html>