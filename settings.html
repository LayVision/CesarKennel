<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตั้งค่าเว็บไซต์ - ซีซาร์ เคนเนล</title>
    <link rel="stylesheet" href="admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
</head>
<body>
    <div class="admin-layout">
        <aside class="sidebar" id="sidebar">
            <div>
                <div class="sidebar-logo">Admin<span>.</span></div>
                <nav class="sidebar-nav">
                    <h3>เมนูหลัก</h3>
                    <ul>
                        <li><a href="admin.html">จัดการสุนัข</a></li>
                        <li><a href="settings.html" class="active">ตั้งค่าเว็บไซต์</a></li>
                    </ul>
                </nav>
            </div>
             <nav class="sidebar-nav">
                <ul>
                    <li><a href="index.html">ดูหน้าร้าน</a></li>
                    <li><a href="#" class="logout-link" id="logout-button">ออกจากระบบ</a></li>
                </ul>
            </nav>
        </aside>

        <main class="admin-main">
            <header class="mobile-header">
                <div class="mobile-logo">Admin<span>.</span></div>
                <button class="mobile-menu-button" id="menu-toggle">☰</button>
            </header>
            
            <header class="desktop-header">
                <h1>ตั้งค่าเว็บไซต์</h1>
            </header>

            <form id="settings-form" class="admin-card">
                <h2>ปรับแต่งหน้าแรก</h2>
                <div class="form-grid">
                    <div class="input-group full-width">
                        <label for="cover-image-upload">รูปภาพหน้าปก (จะแสดงแทนที่โลโก้)</label>
                        <input type="file" id="cover-image-upload" name="cover-image" accept="image/*">
                    </div>
                    <div class="input-group full-width">
                        <label for="marquee-text">ข้อความวิ่ง</label>
                        <input type="text" id="marquee-text" name="marquee-text" value="✨ สุนัขสุขภาพดี เกรดพรีเมียม พร้อมย้ายบ้านแล้ววันนี้! ✨">
                    </div>
                </div>

                <!-- NEW: "About Us" Section Manager -->
                <h2 class="form-section-header">ส่วน "เกี่ยวกับเรา" (แสดงผลหน้าแรก)</h2>
                <div class="form-grid">
                     <div class="input-group full-width">
                        <label for="about-headline">หัวข้อ</label>
                        <input type="text" id="about-headline" name="about-headline" value="คุณพร้อมหลงรักหรือยัง?">
                    </div>
                     <div class="input-group full-width">
                        <label for="about-paragraph">เนื้อหา</label>
                        <textarea id="about-paragraph" name="about-paragraph" rows="5">ไซบีเรียน ฮัสกี้ เป็นสุนัขที่มีเสน่ห์เกินต้านทาน! ด้วยดวงตาสะกดใจ ขนหนานุ่ม และบุคลิกที่ร่าเริง ชอบเล่น และฉลาด พวกเขาพร้อมที่จะเป็นเพื่อนที่ดีที่สุดและเติมเต็มพลังบวกให้กับทุกบ้าน ไซบีเรียน ฮัสกี้จาก Cesar Kennel ได้รับการดูแลอย่างดีเยี่ยมตั้งแต่เล็ก เพื่อส่งมอบน้องหมาที่มีสุขภาพแข็งแรงและพร้อมเรียนรู้สิ่งใหม่ๆ ไปกับคุณ!</textarea>
                    </div>
                    <div class="input-group">
                        <label for="about-image-1">รูปภาพ #1</label>
                        <input type="file" id="about-image-1" accept="image/*">
                        <div class="image-preview-item" id="about-preview-1" style="width:120px; height:120px; margin-top:10px; display:none;"></div>
                    </div>
                    <div class="input-group">
                        <label for="about-image-2">รูปภาพ #2</label>
                        <input type="file" id="about-image-2" accept="image/*">
                        <div class="image-preview-item" id="about-preview-2" style="width:120px; height:120px; margin-top:10px; display:none;"></div>
                    </div>
                </div>

                <h2 class="form-section-header">แกลเลอรี่หน้าแรก (ลากเพื่อจัดลำดับ, สูงสุด 10 รูป)</h2>
                <div class="input-group full-width">
                    <label for="gallery-image-upload">อัปโหลดรูปภาพใหม่สำหรับแกลเลอรี่</label>
                    <input type="file" id="gallery-image-upload" multiple accept="image/*">
                </div>
                <div id="gallery-preview-container" class="image-preview-container">
                    <!-- Gallery image previews will be generated here -->
                </div>

                <div class="form-actions full-width">
                   <button type="submit" class="button button-primary">บันทึกการตั้งค่าทั้งหมด</button>
               </div>
            </form>
        </main>
    </div>

    <div id="crop-modal" class="crop-modal">
        <div class="crop-modal-content">
            <h3>ตัดรูปภาพหน้าปก</h3>
            <div class="crop-image-container">
                <img id="image-to-crop" src="">
            </div>
            <div class="crop-modal-actions">
                <button type="button" id="cancel-crop-btn" class="button button-secondary">ยกเลิก</button>
                <button type="button" id="crop-btn" class="button button-primary">ตัดและใช้งานรูปนี้</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA85L7n2CGKocgWg-Z8TsNlUN9AVVJguBQ",
            authDomain: "cesarkennel.firebaseapp.com",
            projectId: "cesarkennel",
            storageBucket: "cesarkennel.firebasestorage.app",
            messagingSenderId: "512752480416",
            appId: "1:512752480416:web:c71aa9dc281a3932b419c5"
        };
        
        const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);
        const auth = getAuth(app);
        const IMG_BB_API_KEY = '2c1b183962c1d06f8aecea08cbc78d11';

        onAuthStateChanged(auth, user => { if (!user) window.location.href = 'login.html' });
        document.getElementById('logout-button')?.addEventListener('click', (e) => {
            e.preventDefault();
            signOut(auth).then(() => {
                alert('คุณออกจากระบบแล้ว');
                window.location.href = 'index.html';
            });
        });

        // --- DOM Elements ---
        const settingsForm = document.getElementById('settings-form');
        const marqueeTextInput = document.getElementById('marquee-text');
        const coverImageInput = document.getElementById('cover-image-upload');
        const galleryImageInput = document.getElementById('gallery-image-upload');
        const galleryPreviewContainer = document.getElementById('gallery-preview-container');
        const aboutHeadlineInput = document.getElementById('about-headline');
        const aboutParagraphInput = document.getElementById('about-paragraph');
        const aboutImage1Input = document.getElementById('about-image-1');
        const aboutImage2Input = document.getElementById('about-image-2');
        const aboutPreview1 = document.getElementById('about-preview-1');
        const aboutPreview2 = document.getElementById('about-preview-2');
        const settingsRef = doc(db, "settings", "siteConfig");
        
        // --- State Variables ---
        const newGalleryFilesMap = new Map();
        let currentAboutImage1Url = null;
        let currentAboutImage2Url = null;
        let croppedBlob = null;
        
        // --- Utility Functions ---
        const uploadImageAsBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    const body = new URLSearchParams();
                    body.append('image', base64String);
                    fetch(`https://api.imgbb.com/1/upload?key=${IMG_BB_API_KEY}`, { method: 'POST', body: body })
                        .then(res => res.json())
                        .then(result => result.success ? resolve(result.data.url) : reject(new Error(result.error?.message)))
                        .catch(reject);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        // --- Gallery Logic ---
        const createGalleryPreviewElement = (id, src, isExisting = false) => {
             if (galleryPreviewContainer.children.length >= 10) { alert('คุณสามารถอัปโหลดรูปภาพแกลเลอรี่ได้สูงสุด 10 รูป'); return; }
            const wrapper = document.createElement('div');
            wrapper.className = 'image-preview-item';
            wrapper.dataset.id = id;
            if (isExisting) wrapper.dataset.url = src;
            wrapper.innerHTML = `<span class="drag-handle">☰</span><img src="${src}" alt="Gallery preview"><button type="button" class="remove-btn" title="Remove image">&times;</button>`;
            galleryPreviewContainer.appendChild(wrapper);
        };
        galleryImageInput.addEventListener('change', (e) => {
            for (const file of e.target.files) {
                if (galleryPreviewContainer.children.length >= 10) break;
                const uniqueId = `${Date.now()}-${file.name}`;
                newGalleryFilesMap.set(uniqueId, file);
                const reader = new FileReader();
                reader.onload = (event) => createGalleryPreviewElement(uniqueId, event.target.result, false);
                reader.readAsDataURL(file);
            }
            e.target.value = '';
        });
        galleryPreviewContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-btn')) {
                const wrapper = e.target.closest('.image-preview-item');
                if (wrapper) { newGalleryFilesMap.delete(wrapper.dataset.id); wrapper.remove(); }
            }
        });
        new Sortable(galleryPreviewContainer, { animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost' });

        // --- Load & Save ---
        const loadCurrentSettings = async () => {
            const docSnap = await getDoc(settingsRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.marqueeText) marqueeTextInput.value = data.marqueeText;
                if (data.galleryImageUrls) data.galleryImageUrls.forEach(url => createGalleryPreviewElement(url, url, true));
                if (data.aboutHeadline) aboutHeadlineInput.value = data.aboutHeadline;
                if (data.aboutParagraph) aboutParagraphInput.value = data.aboutParagraph;
                if (data.aboutImageUrl1) {
                    currentAboutImage1Url = data.aboutImageUrl1;
                    aboutPreview1.innerHTML = `<img src="${currentAboutImage1Url}" alt="Preview 1">`;
                    aboutPreview1.style.display = 'block';
                }
                 if (data.aboutImageUrl2) {
                    currentAboutImage2Url = data.aboutImageUrl2;
                    aboutPreview2.innerHTML = `<img src="${currentAboutImage2Url}" alt="Preview 2">`;
                    aboutPreview2.style.display = 'block';
                }
            }
        };
        loadCurrentSettings();
        
        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = settingsForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'กำลังบันทึก...';

            try {
                let coverImageUrl = null;
                if (croppedBlob) coverImageUrl = await uploadImageAsBase64(croppedBlob);
                
                const aboutUrl1 = aboutImage1Input.files[0] ? await uploadImageAsBase64(aboutImage1Input.files[0]) : currentAboutImage1Url;
                const aboutUrl2 = aboutImage2Input.files[0] ? await uploadImageAsBase64(aboutImage2Input.files[0]) : currentAboutImage2Url;
                
                const galleryItems = Array.from(galleryPreviewContainer.querySelectorAll('.image-preview-item'));
                const galleryUploadPromises = galleryItems.map(item => {
                    if (item.dataset.url) return Promise.resolve(item.dataset.url);
                    const file = newGalleryFilesMap.get(item.dataset.id);
                    return file ? uploadImageAsBase64(file) : Promise.resolve(null);
                });
                const finalGalleryImageUrls = (await Promise.all(galleryUploadPromises)).filter(Boolean);

                const settingsData = {
                    marqueeText: marqueeTextInput.value,
                    galleryImageUrls: finalGalleryImageUrls,
                    aboutHeadline: aboutHeadlineInput.value,
                    aboutParagraph: aboutParagraphInput.value,
                    aboutImageUrl1: aboutUrl1,
                    aboutImageUrl2: aboutUrl2,
                };
                if (coverImageUrl) settingsData.coverImageUrl = coverImageUrl;

                await setDoc(settingsRef, settingsData, { merge: true });
                alert('บันทึกการตั้งค่าสำเร็จ!');
                window.location.reload();

            } catch (error) {
                console.error('Error saving settings: ', error);
                alert(`เกิดข้อผิดพลาด: ${error.message}`);
                submitButton.disabled = false;
                submitButton.textContent = 'บันทึกการตั้งค่าทั้งหมด';
            }
        });
    </script>
</body>
</html>