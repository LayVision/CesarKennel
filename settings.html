<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตั้งค่าเว็บไซต์ - ปอมปอม บูทีค</title>
    <link rel="stylesheet" href="admin-style.css">
    <style>
        #cover-image-preview-container {
            margin-top: 10px;
        }
        #cover-image-preview {
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div>
                <div class="sidebar-logo"><span class="logo-text-placeholder">Admin</span><span>.</span></div>
                <nav class="sidebar-nav">
                    <h3>เมนูหลัก</h3>
                    <ul>
                        <li><a href="admin.html">จัดการน้องหมา</a></li>
                        <li><a href="settings.html" class="active">ตั้งค่าเว็บไซต์</a></li>
                    </ul>
                </nav>
            </div>
             <nav class="sidebar-nav">
                <ul>
                    <li><a href="index.html" target="_blank">ดูหน้าร้าน</a></li>
                    <li><a href="#" class="logout-link" id="logout-button">ออกจากระบบ</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="mobile-header">
                <div class="mobile-logo"><span class="logo-text-placeholder">Admin</span><span>.</span></div>
                <button class="mobile-menu-button" id="menu-toggle">☰</button>
            </header>
            
            <header class="desktop-header">
                <h1>ตั้งค่าเว็บไซต์</h1>
            </header>

            <form id="settings-form" class="admin-card">
                <h2>ปรับแต่งหน้าแรก</h2>
                <div class="form-grid">
                    <div class="input-group full-width">
                        <label for="cover-image-upload">รูปภาพหน้าปก (Cover Image)</label>
                        <input type="file" id="cover-image-upload" name="cover-image" accept="image/*">
                        <div id="cover-image-preview-container"></div>
                    </div>
                    <div class="input-group full-width">
                        <label for="marquee-text">ข้อความวิ่ง</label>
                        <input type="text" id="marquee-text" name="marquee-text">
                    </div>
                </div>

                <h2 class="form-section-header">ข้อมูลร้านค้า</h2>
                <div class="form-grid">
                   <div class="input-group"><label for="shopName">ชื่อร้าน</label><input type="text" id="shopName" name="shopName"></div>
                   <div class="input-group"><label for="logoText">ข้อความโลโก้</label><input type="text" id="logoText" name="logoText"></div>
                   <div class="input-group"><label for="contactEmail">อีเมลติดต่อ</label><input type="email" id="contactEmail" name="contactEmail"></div>
                   <div class="input-group"><label for="copyrightYear">ปีลิขสิทธิ์</label><input type="text" id="copyrightYear" name="copyrightYear"></div>
                </div>

                <h2 class="form-section-header">ข้อมูลส่วนท้ายเว็บและโซเชียลมีเดีย</h2>
                <div class="form-grid">
                   <div class="input-group full-width">
                       <label for="footerDescription">คำอธิบายสั้นๆ ท้ายเว็บ</label>
                       <input type="text" id="footerDescription" name="footerDescription">
                   </div>
                   <div class="input-group">
                       <label for="footerPhone">เบอร์โทรศัพท์</label>
                       <input type="text" id="footerPhone" name="footerPhone">
                   </div>
                   <div class="input-group">
                       <label for="footerFacebook">Facebook URL</label>
                       <input type="url" id="footerFacebook" name="footerFacebook" placeholder="https://facebook.com/yourpage">
                   </div>
                    <div class="input-group">
                       <label for="footerInstagram">Instagram URL</label>
                       <input type="url" id="footerInstagram" name="footerInstagram" placeholder="https://instagram.com/yourprofile">
                   </div>
                    <div class="input-group">
                       <label for="footerLine">LINE URL หรือ ID</label>
                       <input type="text" id="footerLine" name="footerLine" placeholder="https://line.me/ti/p/~@yourid">
                   </div>
                </div>

                <div class="form-actions full-width">
                   <button type="submit" id="save-button" class="button button-primary">บันทึกการตั้งค่าทั้งหมด</button>
               </div>
            </form>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="script.js"></script>
    
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyA85L7n2CGKocgWg-Z8TsNlUN9AVVJguBQ",
          authDomain: "cesarkennel.firebaseapp.com",
          projectId: "cesarkennel",
          storageBucket: "cesarkennel.firebasestorage.app",
          messagingSenderId: "512752480416",
          appId: "1:512752480416:web:c71aa9dc281a3932b419c5"
        };
        const app = firebase.initializeApp(firebaseConfig);
        
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                loadSettings();
            } else {
                window.location.href = 'login.html';
            }
        });
    
        const db = firebase.firestore();
        const settingsForm = document.getElementById('settings-form');
        const saveButton = document.getElementById('save-button');
        const previewContainer = document.getElementById('cover-image-preview-container');
        
        const settingsRef = db.collection('settings').doc('main_config');
        let currentCoverImageUrl = '';

        async function loadSettings() {
            try {
                const docSnap = await settingsRef.get();
                if (docSnap.exists) {
                    const settings = docSnap.data();
                    
                    document.getElementById('marquee-text').value = settings.marqueeText || '';
                    document.getElementById('shopName').value = settings.shopName || '';
                    document.getElementById('logoText').value = settings.logoText || '';
                    document.getElementById('contactEmail').value = settings.contactEmail || '';
                    document.getElementById('copyrightYear').value = settings.copyrightYear || '';
                    document.getElementById('footerDescription').value = settings.footerDescription || '';
                    document.getElementById('footerPhone').value = settings.footerPhone || '';
                    document.getElementById('footerFacebook').value = settings.footerFacebook || '';
                    document.getElementById('footerInstagram').value = settings.footerInstagram || '';
                    document.getElementById('footerLine').value = settings.footerLine || '';

                    if (settings.coverImageUrl) {
                        currentCoverImageUrl = settings.coverImageUrl;
                        previewContainer.innerHTML = `<img id="cover-image-preview" src="${currentCoverImageUrl}" alt="Cover Image Preview">`;
                    }
                } else {
                    console.log("No settings document found. A new one will be created on save.");
                }
            } catch (error) {
                console.error("Error loading settings:", error);
                alert('เกิดข้อผิดพลาดในการโหลดการตั้งค่า');
            }
        }

        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            saveButton.disabled = true;
            saveButton.textContent = 'กำลังบันทึก...';

            try {
                const imageFile = document.getElementById('cover-image-upload').files[0];
                let newImageUrl = null;
                if (imageFile) {
                    newImageUrl = await uploadImageToImgBB(imageFile);
                }

                const settingsData = {
                    marqueeText: document.getElementById('marquee-text').value,
                    shopName: document.getElementById('shopName').value,
                    logoText: document.getElementById('logoText').value,
                    contactEmail: document.getElementById('contactEmail').value,
                    copyrightYear: document.getElementById('copyrightYear').value,
                    footerDescription: document.getElementById('footerDescription').value,
                    footerPhone: document.getElementById('footerPhone').value,
                    footerFacebook: document.getElementById('footerFacebook').value,
                    footerInstagram: document.getElementById('footerInstagram').value,
                    footerLine: document.getElementById('footerLine').value,
                    coverImageUrl: newImageUrl || currentCoverImageUrl,
                };

                await settingsRef.set(settingsData, { merge: true });

                alert('บันทึกการตั้งค่าสำเร็จ!');
                if (newImageUrl) {
                    location.reload();
                }

            } catch (error) {
                console.error("Error saving settings:", error);
                alert(`เกิดข้อผิดพลาดในการบันทึก: ${error.message}`);
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'บันทึกการตั้งค่าทั้งหมด';
            }
        });
    </script>
</body>
</html>