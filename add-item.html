<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เพิ่ม/แก้ไข ข้อมูลน้องหมา</title>
    <link rel="stylesheet" href="admin-style.css">
    <style>
        /* Styles for image previews */
        #existing-images-grid {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .img-preview-wrapper {
            position: relative;
        }
        .img-preview-wrapper img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }
        .delete-img-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-red);
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-weight: bold;
            text-align: center;
            line-height: 20px;
            cursor: pointer;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
             <div>
                <div class="sidebar-logo">Admin<span>.</span></div>
                <nav class="sidebar-nav">
                    <h3>เมนูหลัก</h3>
                    <ul>
                        <li><a href="admin.html">จัดการน้องหมา</a></li>
                        <li><a href="settings.html">ตั้งค่าเว็บไซต์</a></li>
                    </ul>
                </nav>
            </div>
             <nav class="sidebar-nav">
                <ul>
                    <li><a href="index.html" target="_blank">ดูหน้าร้าน</a></li>
                    <li><a href="#" class="logout-link" id="logout-button">ออกจากระบบ</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="desktop-header">
                <h1 id="page-title">เพิ่มข้อมูลน้องหมา</h1>
                <a href="admin.html" class="button button-secondary">&larr; กลับไปที่รายการ</a>
            </header>

            <!-- IMPORTANT: Removed hardcoded values from the form inputs -->
            <form id="dog-form" class="admin-card">
                <h2>ข้อมูลทั่วไป</h2>
                <div class="form-grid">
                    <div class="input-group"><label for="name">ชื่อ / หัวข้อประกาศ</label><input type="text" id="name" required></div>
                    <div class="input-group"><label for="breed">สายพันธุ์</label><input type="text" id="breed" required></div>
                    <div class="input-group"><label for="age">อายุ</label><input type="text" id="age" required></div>
                    <div class="input-group"><label for="price">ราคา (บาท)</label><input type="number" id="price" required></div>
                    <div class="input-group"><label for="discount-price">ราคาลดแล้ว (บาท)</label><input type="number" id="discount-price" placeholder="เว้นว่างถ้าไม่มีส่วนลด"></div>
                    <div class="input-group"><label for="gender">เพศ</label><select id="gender" required><option value="เมีย">เมีย</option><option value="ผู้">ผู้</option></select></div>
                    <div class="input-group"><label for="color">ตัวสี</label><input type="text" id="color" required></div>
                    <div class="input-group"><label for="eye-color">ตาสี</label><input type="text" id="eye-color"></div>
                    <div class="input-group"><label for="vaccine">วัคซีน</label><input type="text" id="vaccine"></div>
                    <div class="input-group"><label for="status">สถานะ</label><select id="status" required><option value="available">พร้อมย้ายบ้าน</option><option value="preordered">ติดจอง</option><option value="sold">ขายแล้ว</option></select></div>
                    <div class="input-group full-width"><label for="description">รายละเอียดเพิ่มเติม</label><textarea id="description" rows="4"></textarea></div>
                </div>

                <h2 class="form-section-header">รูปภาพ</h2>
                 <div id="existing-images-container" class="input-group full-width">
                    <!-- Existing images will be shown here by JavaScript -->
                 </div>
                 <div class="input-group full-width">
                    <label for="image_upload">อัปโหลดรูปภาพใหม่ (รูปแรกจะเป็นรูปปก)</label>
                    <input type="file" id="image_upload" multiple accept="image/*">
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="button button-primary" id="submit-button">บันทึกข้อมูล</button>
                </div>
            </form>
        </main>
    </div>

    <!-- REQUIRED SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyA85L7n2CGKocgWg-Z8TsNlUN9AVVJguBQ",
          authDomain: "cesarkennel.firebaseapp.com",
          projectId: "cesarkennel",
          storageBucket: "cesarkennel.firebasestorage.app",
          messagingSenderId: "512752480416",
          appId: "1:512752480416:web:c71aa9dc281a3932b419c5"
        };
        const app = firebase.initializeApp(firebaseConfig);

        // --- AUTH GUARD: Protects the page ---
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                // User is signed in, so we can run the form logic.
                initializeForm();
            } else {
                // Redirect if not logged in.
                window.location.href = 'login.html';
            }
        });
    </script>
    
    <!-- This script file contains image upload functions -->
    <script src="script.js"></script>

    <script>
        // This is the CORE LOGIC for this page
        const db = firebase.firestore();
        const form = document.getElementById('dog-form');
        const pageTitle = document.getElementById('page-title');
        const submitButton = document.getElementById('submit-button');
        const existingImagesContainer = document.getElementById('existing-images-container');

        const urlParams = new URLSearchParams(window.location.search);
        const dogId = urlParams.get('id');
        const isEditMode = !!dogId;
        let existingImageUrls = [];

        // Function to check URL for an ID and load data if it's an edit
        async function initializeForm() {
            if (isEditMode) {
                pageTitle.textContent = 'แก้ไขข้อมูลน้องหมา';
                submitButton.textContent = 'บันทึกการแก้ไข';
                try {
                    const docRef = db.collection('dogs').doc(dogId);
                    const docSnap = await docRef.get();
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        // Pre-fill the form with data from Firestore
                        document.getElementById('name').value = data.name || '';
                        document.getElementById('breed').value = data.breed || '';
                        document.getElementById('age').value = data.age || '';
                        document.getElementById('price').value = data.price || 0;
                        document.getElementById('discount-price').value = data.discountPrice || '';
                        document.getElementById('gender').value = data.gender || 'เมีย';
                        document.getElementById('color').value = data.color || '';
                        document.getElementById('eye-color').value = data.eyeColor || '';
                        document.getElementById('vaccine').value = data.vaccine || '';
                        document.getElementById('status').value = data.status || 'available';
                        document.getElementById('description').value = data.description || '';
                        
                        existingImageUrls = data.imageUrls || [];
                        renderExistingImages();
                    }
                } catch (error) {
                    console.error("Error fetching dog data:", error);
                    alert('ไม่สามารถโหลดข้อมูลสำหรับแก้ไขได้');
                }
            }
        }
        
        // Function to display image previews for existing images
        function renderExistingImages() {
            existingImagesContainer.innerHTML = '';
            if (existingImageUrls.length === 0) return;
            
            existingImagesContainer.innerHTML = '<h4>รูปภาพปัจจุบัน</h4>';
            const imageGrid = document.createElement('div');
            imageGrid.id = 'existing-images-grid';
            
            existingImageUrls.forEach((url, index) => {
                const imgWrapper = document.createElement('div');
                imgWrapper.className = 'img-preview-wrapper';
                imgWrapper.innerHTML = `
                    <img src="${url}" alt="Existing image ${index + 1}">
                    <button type="button" class="delete-img-btn" data-index="${index}">X</button>
                `;
                imageGrid.appendChild(imgWrapper);
            });
            existingImagesContainer.appendChild(imageGrid);
            
            // Make the 'X' buttons work
            imageGrid.querySelectorAll('.delete-img-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const indexToRemove = parseInt(e.target.dataset.index, 10);
                    existingImageUrls.splice(indexToRemove, 1);
                    renderExistingImages(); // Re-render the previews
                });
            });
        }

        // Main function that runs when the "Save" button is clicked
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitButton.disabled = true;
            submitButton.textContent = 'กำลังบันทึก...';
            
            try {
                // 1. Upload any new images
                const imageFiles = document.getElementById('image_upload').files;
                let newImageUrls = [];
                if (imageFiles.length > 0) {
                    // This function is in script.js
                    newImageUrls = await uploadMultipleImages(imageFiles);
                }
                
                // 2. Combine old and new image URLs
                const allImageUrls = [...existingImageUrls, ...newImageUrls];
                if (allImageUrls.length === 0) {
                    throw new Error('กรุณาอัปโหลดหรือคงเหลือรูปภาพอย่างน้อย 1 รูป');
                }

                // 3. Prepare the data object to be saved
                const dogData = {
                    name: document.getElementById('name').value,
                    breed: document.getElementById('breed').value,
                    age: document.getElementById('age').value,
                    price: Number(document.getElementById('price').value),
                    discountPrice: Number(document.getElementById('discount-price').value) || 0,
                    gender: document.getElementById('gender').value,
                    color: document.getElementById('color').value,
                    eyeColor: document.getElementById('eye-color').value,
                    vaccine: document.getElementById('vaccine').value,
                    status: document.getElementById('status').value,
                    description: document.getElementById('description').value,
                    imageUrls: allImageUrls
                };

                // 4. Save to Firebase
                if (isEditMode) {
                    // Update an existing document
                    await db.collection("dogs").doc(dogId).update(dogData);
                    alert('อัปเดตข้อมูลสำเร็จ!');
                } else {
                    // Create a new document
                    const docCountSnapshot = await db.collection("dogs").get();
                    dogData.order = docCountSnapshot.size; // Set initial order
                    dogData.createdAt = firebase.firestore.FieldValue.serverTimestamp(); // Set timestamp for sorting
                    await db.collection("dogs").add(dogData);
                    alert('เพิ่มน้องหมาสำเร็จ!');
                }
                
                window.location.href = 'admin.html'; // Go back to the list

            } catch (error) {
                console.error("Error saving dog data:", error);
                alert(`เกิดข้อผิดพลาด: ${error.message}`);
            } finally {
                // Re-enable the button after success or failure
                submitButton.disabled = false;
                submitButton.textContent = isEditMode ? 'บันทึกการแก้ไข' : 'บันทึกข้อมูล';
            }
        });
    </script>
</body>
</html>