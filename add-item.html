<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เพิ่ม/แก้ไข ข้อมูลน้องหมา</title>
    <link rel="stylesheet" href="admin-style.css">
</head>
<body>
    <div class="admin-layout">
        <aside class="sidebar" id="sidebar">
            <div>
                <div class="sidebar-logo">Admin<span>.</span></div>
                <nav class="sidebar-nav">
                    <h3>เมนูหลัก</h3>
                    <ul>
                        <li><a href="admin.html" class="active">จัดการน้องหมา</a></li>
                        <li><a href="settings.html">ตั้งค่าเว็บไซต์</a></li>
                    </ul>
                </nav>
            </div>
             <nav class="sidebar-nav">
                <ul>
                    <li><a href="index.html">ดูหน้าร้าน</a></li>
                    <li><a href="#" class="logout-link" id="logout-button">ออกจากระบบ</a></li>
                </ul>
            </nav>
        </aside>

        <main class="admin-main">
             <header class="mobile-header">
                <div class="mobile-logo">Admin<span>.</span></div>
                <button class="mobile-menu-button" id="menu-toggle">☰</button>
            </header>

            <header class="desktop-header">
                <h1 id="page-title">เพิ่มข้อมูลน้องหมา</h1>
                <a href="admin.html" class="button button-secondary">&larr; กลับไปที่รายการ</a>
            </header>

            <form class="admin-card">
                <h2>ข้อมูลทั่วไป</h2>
                <div class="form-grid">
                    <div class="input-group"><label for="name">ชื่อ / หัวข้อประกาศ</label><input type="text" id="name" name="name" required></div>
                    <div class="input-group"><label for="breed">สายพันธุ์</label><input type="text" id="breed" name="breed" value="ปอมเมอเรเนียน" required></div>
                    <div class="input-group"><label for="age">อายุ</label><input type="text" id="age" name="age" required></div>
                    <div class="input-group"><label for="price">ราคา (บาท)</label><input type="number" id="price" name="price" required></div>
                    <div class="input-group"><label for="discount-price">ราคาลดแล้ว (บาท)</label><input type="number" id="discount-price" name="discount-price" placeholder="เว้นว่างถ้าไม่มีส่วนลด"></div>
                    
                    <div class="input-group">
                        <label for="gender">เพศ</label>
                        <select id="gender" name="gender" required><option value="เมีย" selected>เมีย</option><option value="ผู้">ผู้</option></select>
                    </div>
                    <div class="input-group">
                        <label for="color">ตัวสี</label>
                        <input type="text" id="color" name="color" required>
                    </div>
                    <div class="input-group">
                        <label for="eye-color">ตาสี</label>
                        <input type="text" id="eye-color" name="eye-color">
                    </div>
                    <div class="input-group">
                        <label for="vaccine">วัคซีน</label>
                        <input type="text" id="vaccine" name="vaccine">
                    </div>
                    <div class="input-group">
                        <label for="status">สถานะ</label>
                        <select id="status" name="status" required>
                            <option value="available" selected>พร้อมย้ายบ้าน</option>
                            <option value="preordered">ติดจอง</option>
                            <option value="sold">ขายแล้ว</option>
                        </select>
                    </div>
                    <div class="input-group full-width">
                        <label for="description">รายละเอียดเพิ่มเติม</label>
                        <textarea id="description" name="description" rows="4"></textarea>
                    </div>
                </div>

                <h2 class="form-section-header">รูปภาพ (ลากเพื่อจัดลำดับ รูปแรกคือรูปปก)</h2>
                <div class="input-group full-width">
                    <label for="image_upload">อัปโหลดรูปภาพใหม่</label>
                    <input type="file" id="image_upload" name="image_upload[]" multiple accept="image/*">
                </div>
                <!-- NEW: Container for image previews -->
                <div id="image-preview-container" class="image-preview-container">
                    <!-- Previews will be generated here -->
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="button button-primary">บันทึกข้อมูล</button>
                </div>
            </form>
        </main>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="script.js"></script>

    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, collection, updateDoc, serverTimestamp, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA85L7n2CGKocgWg-Z8TsNlUN9AVVJguBQ",
            authDomain: "cesarkennel.firebaseapp.com",
            projectId: "cesarkennel",
            storageBucket: "cesarkennel.firebasestorage.app",
            messagingSenderId: "512752480416",
            appId: "1:512752480416:web:c71aa9dc281a3932b419c5"
        };
        
        const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);
        const auth = getAuth(app);
        const IMG_BB_API_KEY = '2c1b183962c1d06f8aecea08cbc78d11';

        // --- Auth & Logout ---
        onAuthStateChanged(auth, user => { if (!user) window.location.href = 'login.html' });
        document.getElementById('logout-button')?.addEventListener('click', (e) => {
            e.preventDefault();
            signOut(auth).then(() => {
                alert('คุณออกจากระบบแล้ว');
                window.location.href = 'index.html';
            });
        });

        // --- DOM Elements ---
        const form = document.querySelector('form.admin-card');
        const pageTitle = document.getElementById('page-title');
        const imageInput = document.getElementById('image_upload');
        const previewContainer = document.getElementById('image-preview-container');
        const urlParams = new URLSearchParams(window.location.search);
        const itemId = urlParams.get('id');

        // --- State Management for Images ---
        // Use a Map to store new File objects, keyed by a unique identifier (timestamp + filename)
        const newFilesMap = new Map();

        // --- Image Preview & Sorting Logic ---
        const createPreviewElement = (id, src, isExisting = false) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'image-preview-item';
            wrapper.dataset.id = id; // Unique ID for both new and existing images
            if (isExisting) {
                wrapper.dataset.url = src; // Store original URL for existing images
            }

            wrapper.innerHTML = `
                <span class="drag-handle">☰</span>
                <img src="${src}" alt="Image preview">
                <button type="button" class="remove-btn" title="Remove image">&times;</button>
            `;
            previewContainer.appendChild(wrapper);
        };

        imageInput.addEventListener('change', (e) => {
            for (const file of e.target.files) {
                const uniqueId = `${Date.now()}-${file.name}`;
                newFilesMap.set(uniqueId, file);
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    createPreviewElement(uniqueId, event.target.result, false);
                };
                reader.readAsDataURL(file);
            }
            e.target.value = ''; // Reset input to allow selecting the same file again
        });

        previewContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-btn')) {
                const wrapper = e.target.closest('.image-preview-item');
                if (wrapper) {
                    const id = wrapper.dataset.id;
                    newFilesMap.delete(id); // Remove from new files map if it exists there
                    wrapper.remove();
                }
            }
        });

        // Initialize SortableJS on the preview container
        new Sortable(previewContainer, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost'
        });

        // --- Form Population (for Edit Mode) ---
        const populateForm = async (id) => {
            pageTitle.textContent = 'แก้ไขข้อมูลน้องหมา';
            const docRef = doc(db, 'products', id);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('name').value = data.name || '';
                document.getElementById('breed').value = data.breed || '';
                document.getElementById('age').value = data.age || '';
                document.getElementById('price').value = data.price || '';
                document.getElementById('discount-price').value = data.discountPrice || '';
                document.getElementById('gender').value = data.gender || 'เมีย';
                document.getElementById('color').value = data.color || '';
                document.getElementById('eye-color').value = data.eyeColor || '';
                document.getElementById('vaccine').value = data.vaccine || '';
                document.getElementById('status').value = data.status || 'available';
                document.getElementById('description').value = data.description || '';

                // Populate existing images
                if (data.imageUrls && Array.isArray(data.imageUrls)) {
                    data.imageUrls.forEach(url => {
                        createPreviewElement(url, url, true); // Use URL as ID for existing
                    });
                }
            } else {
                alert('ไม่พบข้อมูลน้องหมา');
                window.location.href = 'admin.html';
            }
        };
        
        if (itemId) {
            populateForm(itemId);
        }

        // --- Form Submission Logic ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'กำลังบันทึก...';

            try {
                // Step 1: Get the final sorted order of all images from the DOM
                const previewItems = Array.from(previewContainer.querySelectorAll('.image-preview-item'));

                // Step 2: Process all images (existing and new) in parallel
                const uploadPromises = previewItems.map(item => {
                    const { id, url } = item.dataset;
                    // If it's an existing image (has a data-url), just return its URL
                    if (url) {
                        return Promise.resolve(url);
                    }
                    // If it's a new image, upload it and return the new URL
                    const file = newFilesMap.get(id);
                    if (file) {
                        const formData = new FormData();
                        formData.append('image', file);
                        return fetch(`https://api.imgbb.com/1/upload?key=${IMG_BB_API_KEY}`, { method: 'POST', body: formData })
                            .then(res => res.json())
                            .then(result => {
                                if (result.success) return result.data.url;
                                throw new Error(`Image upload failed for ${file.name}`);
                            });
                    }
                    return Promise.resolve(null); // Should not happen
                });

                const finalImageUrls = (await Promise.all(uploadPromises)).filter(Boolean); // Wait for all uploads and filter out nulls

                // Step 3: Prepare product data for Firestore
                const productData = {
                    name: document.getElementById('name').value,
                    breed: document.getElementById('breed').value,
                    age: document.getElementById('age').value,
                    price: Number(document.getElementById('price').value),
                    discountPrice: Number(document.getElementById('discount-price').value) || 0,
                    gender: document.getElementById('gender').value,
                    color: document.getElementById('color').value,
                    eyeColor: document.getElementById('eye-color').value,
                    vaccine: document.getElementById('vaccine').value,
                    status: document.getElementById('status').value,
                    description: document.getElementById('description').value,
                    updatedAt: serverTimestamp(),
                    imageUrls: finalImageUrls,
                    thumbnailUrl: finalImageUrls.length > 0 ? finalImageUrls[0] : ''
                };

                // Step 4: Save to Firestore
                if (itemId) { // Update existing item
                    const docRef = doc(db, 'products', itemId);
                    await updateDoc(docRef, productData);
                    alert('อัปเดตข้อมูลสำเร็จ!');
                } else { // Add new item
                    const q = query(collection(db, "products"), orderBy("orderPosition", "asc"), limit(1));
                    const querySnapshot = await getDocs(q);
                    const firstPosition = querySnapshot.empty ? 0 : querySnapshot.docs[0].data().orderPosition;
                    productData.orderPosition = (firstPosition || 0) - 1;
                    productData.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'products'), productData);
                    alert('เพิ่มน้องหมาสำเร็จ!');
                }
                window.location.href = 'admin.html';

            } catch (error) {
                console.error('Error saving product: ', error);
                alert(`เกิดข้อผิดพลาด: ${error.message}`);
                submitButton.disabled = false;
                submitButton.textContent = 'บันทึกข้อมูล';
            }
        });
    </script>
</body>
</html>