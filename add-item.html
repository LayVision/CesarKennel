<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เพิ่ม/แก้ไข ข้อมูลน้องหมา</title>
    <link rel="stylesheet" href="admin-style.css">
</head>
<body>
    <!-- Main layout for the admin interface -->
    <div class="admin-layout">
        <!-- Sidebar for admin navigation -->
        <aside class="sidebar" id="sidebar">
            <div>
                <div class="sidebar-logo">Admin<span>.</span></div>
                <nav class="sidebar-nav">
                    <h3>เมนูหลัก</h3>
                    <ul>
                        <li><a href="admin.html" class="active">จัดการน้องหมา</a></li>
                        <li><a href="settings.html">ตั้งค่าเว็บไซต์</a></li>
                    </ul>
                </nav>
            </div>
             <nav class="sidebar-nav">
                <ul>
                    <li><a href="index.html" target="_blank">ดูหน้าร้าน</a></li>
                    <li><a href="#" class="logout-link" id="logout-button">ออกจากระบบ</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main content area for the form -->
        <main class="admin-main">
             <!-- Header for mobile view -->
             <header class="mobile-header">
                <div class="mobile-logo">Admin<span>.</span></div>
                <button class="mobile-menu-button" id="menu-toggle">☰</button>
            </header>

            <!-- Header for desktop view with a back button -->
            <header class="desktop-header">
                <h1>เพิ่มข้อมูลน้องหมา</h1>
                <a href="admin.html" class="button button-secondary">&larr; กลับไปที่รายการ</a>
            </header>

            <!-- Main form for item data, enclosed in a card -->
            <form class="admin-card">
                <h2>ข้อมูลทั่วไป</h2>
                <!-- Grid layout for form fields -->
                <div class="form-grid">
                    <div class="input-group"><label for="name">ชื่อ / หัวข้อประกาศ</label><input type="text" id="name" name="name" required></div>
                    <div class="input-group"><label for="breed">สายพันธุ์</label><input type="text" id="breed" name="breed" value="ปอมเมอเรเนียน" required></div>
                    <div class="input-group"><label for="age">อายุ</label><input type="text" id="age" name="age" required></div>
                    <div class="input-group"><label for="price">ราคา (บาท)</label><input type="number" id="price" name="price" required></div>
                    <div class="input-group"><label for="discount-price">ราคาลดแล้ว (บาท)</label><input type="number" id="discount-price" name="discount-price" placeholder="เว้นว่างถ้าไม่มีส่วนลด"></div>
                    
                    <div class="input-group">
                        <label for="gender">เพศ</label>
                        <select id="gender" name="gender" required><option value="เมีย" selected>เมีย</option><option value="ผู้">ผู้</option></select>
                    </div>
                    <div class="input-group">
                        <label for="color">ตัวสี</label>
                        <input type="text" id="color" name="color" required>
                    </div>
                    <div class="input-group">
                        <label for="eye-color">ตาสี</label>
                        <input type="text" id="eye-color" name="eye-color">
                    </div>
                    <!-- Vaccine information field -->
                    <div class="input-group">
                        <label for="vaccine">วัคซีน</label>
                        <input type="text" id="vaccine" name="vaccine">
                    </div>

                    <div class="input-group">
                        <label for="status">สถานะ</label>
                        <select id="status" name="status" required>
                            <option value="available" selected>พร้อมย้ายบ้าน</option>
                            <option value="preordered">ติดจอง</option>
                            <option value="sold">ขายแล้ว</option>
                        </select>
                    </div>
                    <!-- Full-width textarea for a detailed description -->
                    <div class="input-group full-width">
                        <label for="description">รายละเอียดเพิ่มเติม</label>
                        <textarea id="description" name="description" rows="4"></textarea>
                    </div>
                </div>

                <!-- Section for uploading images -->
                <h2 class="form-section-header">รูปภาพ</h2>
                 <div class="input-group full-width">
                    <label for="image_upload">อัปโหลดรูปภาพใหม่ (รูปแรกจะเป็นรูปปก)</label>
                    <input type="file" id="image_upload" name="image_upload[]" multiple accept="image/*">
                </div>
                
                <!-- Form submission button -->
                <div class="form-actions">
                    <button type="submit" class="button button-primary">บันทึกข้อมูล</button>
                </div>
            </form>
        </main>
    </div>
    <!-- Link to the main JavaScript file -->
    <script src="script.js"></script>

    <!-- Main Firebase Logic for this page -->
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, collection, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- Firebase Initialization (ensures it only runs once) ---
        const firebaseConfig = {
            apiKey: "AIzaSyA85L7n2CGKocgWg-Z8TsNlUN9AVVJguBQ",
            authDomain: "cesarkennel.firebaseapp.com",
            projectId: "cesarkennel",
            storageBucket: "cesarkennel.firebasestorage.app",
            messagingSenderId: "512752480416",
            appId: "1:512752480416:web:c71aa9dc281a3932b419c5"
        };
        
        const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);
        const auth = getAuth(app);
        const IMG_BB_API_KEY = '2c1b183962c1d06f8aecea08cbc78d11';

        // --- Auth Guard: Redirect if not logged in ---
        onAuthStateChanged(auth, user => {
            if (!user) {
                console.log("User not logged in. Redirecting...");
                window.location.href = 'login.html';
            }
        });

        // --- Logout Button Logic ---
        const logoutButton = document.getElementById('logout-button');
        if (logoutButton) {
            logoutButton.addEventListener('click', (e) => {
                e.preventDefault();
                signOut(auth).then(() => {
                    alert('คุณออกจากระบบแล้ว');
                    window.location.href = 'index.html';
                }).catch(error => console.error("Logout Error:", error));
            });
        }

        // --- Page-specific variables and elements ---
        const form = document.querySelector('form.admin-card');
        const pageTitle = document.querySelector('.desktop-header h1');
        const urlParams = new URLSearchParams(window.location.search);
        const itemId = urlParams.get('id');

        // --- Function to populate the form if in "Edit" mode ---
        const populateForm = async (id) => {
            try {
                const docRef = doc(db, 'products', id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    pageTitle.textContent = 'แก้ไขข้อมูลน้องหมา';
                    const data = docSnap.data();
                    document.getElementById('name').value = data.name || '';
                    document.getElementById('breed').value = data.breed || '';
                    document.getElementById('age').value = data.age || '';
                    document.getElementById('price').value = data.price || '';
                    document.getElementById('discount-price').value = data.discountPrice || '';
                    document.getElementById('gender').value = data.gender || 'เมีย';
                    document.getElementById('color').value = data.color || '';
                    document.getElementById('eye-color').value = data.eyeColor || '';
                    document.getElementById('vaccine').value = data.vaccine || '';
                    document.getElementById('status').value = data.status || 'available';
                    document.getElementById('description').value = data.description || '';
                    // Note: This form doesn't display existing images, but they will be kept
                    // unless new images are uploaded, which will overwrite them.
                } else {
                    console.error("Document not found!");
                    alert('ไม่พบข้อมูลน้องหมา');
                    window.location.href = 'admin.html';
                }
            } catch (error) {
                console.error("Error fetching document:", error);
                alert('เกิดข้อผิดพลาดในการดึงข้อมูล');
            }
        };
        
        // --- On Page Load: Check if we are editing an item ---
        if (itemId) {
            populateForm(itemId);
        }

        // --- Form Submission: Handles both "Add" and "Edit" ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'กำลังบันทึก...';

            try {
                // 1. Upload new images to ImgBB
                const imageInput = document.getElementById('image_upload');
                const files = imageInput.files;
                const imageUrls = [];

                if (files.length > 0) {
                    for (const file of files) {
                        const formData = new FormData();
                        formData.append('image', file);
                        const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMG_BB_API_KEY}`, {
                            method: 'POST',
                            body: formData,
                        });
                        const result = await response.json();
                        if (result.success) {
                            imageUrls.push(result.data.url);
                        } else {
                            throw new Error(`Image upload failed: ${result.error.message}`);
                        }
                    }
                }

                // 2. Prepare data object from form fields
                const productData = {
                    name: document.getElementById('name').value,
                    breed: document.getElementById('breed').value,
                    age: document.getElementById('age').value,
                    price: Number(document.getElementById('price').value),
                    discountPrice: Number(document.getElementById('discount-price').value) || 0,
                    gender: document.getElementById('gender').value,
                    color: document.getElementById('color').value,
                    eyeColor: document.getElementById('eye-color').value,
                    vaccine: document.getElementById('vaccine').value,
                    status: document.getElementById('status').value,
                    description: document.getElementById('description').value,
                    updatedAt: serverTimestamp(),
                };

                // 3. Save to Firestore
                if (itemId) {
                    // UPDATE existing document
                    const docRef = doc(db, 'products', itemId);
                    // If new images were uploaded, overwrite the old list
                    if (imageUrls.length > 0) {
                        productData.imageUrls = imageUrls;
                        productData.thumbnailUrl = imageUrls[0];
                    }
                    await updateDoc(docRef, productData);
                    alert('อัปเดตข้อมูลสำเร็จ!');
                } else {
                    // ADD new document
                    productData.imageUrls = imageUrls;
                    productData.thumbnailUrl = imageUrls.length > 0 ? imageUrls[0] : '';
                    productData.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'products'), productData);
                    alert('เพิ่มน้องหมาสำเร็จ!');
                }

                window.location.href = 'admin.html';

            } catch (error) {
                console.error('Error saving product: ', error);
                alert(`เกิดข้อผิดพลาด: ${error.message}`);
                submitButton.disabled = false;
                submitButton.textContent = 'บันทึกข้อมูล';
            }
        });
    </script>

</body>
</html>